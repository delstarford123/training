<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Strategic Master Terminal | IIG SMART FARMERS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        
        :root { --brand-emerald: #064e3b; --brand-slate: #0f172a; }
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f8fafc; overflow-x: hidden; }
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .drawer-transform { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }

        /* Color-Coded Financial Borders */
        .border-msa { border-left: 6px solid #10b981; } .text-msa { color: #10b981; }
        .border-gff { border-left: 6px solid #ef4444; } .text-gff { color: #ef4444; }
        .border-gmf { border-left: 6px solid #0ea5e9; } .text-gmf { color: #0ea5e9; }
        .border-gsf { border-left: 6px solid #3b82f6; } .text-gsf { color: #3b82f6; }
        .border-psa { border-left: 6px solid #8b5cf6; } .text-psa { color: #8b5cf6; }
        .border-fis { border-left: 6px solid #f59e0b; } .text-fis { color: #f59e0b; }
        .border-gca { border-left: 6px solid #064e3b; } .text-gca { color: #064e3b; }
        .border-afs { border-left: 6px solid #d946ef; } .text-afs { color: #d946ef; }

        @keyframes pulse-red {
            0% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0.7); }
            70% { transform: scale(1.1); box-shadow: 0 0 0 10px rgba(239, 68, 68, 0); }
            100% { transform: scale(1); box-shadow: 0 0 0 0 rgba(239, 68, 68, 0); }
        }
        .notif-pulse { animation: pulse-red 2s infinite; }

        @media print {
            .no-print, nav, aside, button, #notif-panel, #sidebar-overlay { display: none !important; }
            body { background: white !important; }
            .member-card { border: 1px solid #e2e8f0 !important; box-shadow: none !important; border-radius: 1rem !important; }
            .audit-box { break-inside: avoid; border: 1px solid #e2e8f0 !important; margin-bottom: 1rem; }
        }
    </style>
</head>
<body class="text-slate-900 flex flex-col h-screen">

    <nav class="h-20 bg-white/80 backdrop-blur-xl border-b flex justify-between items-center px-4 md:px-8 z-[1000] sticky top-0 no-print">
        <div class="flex items-center space-x-4">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 text-slate-500"><i class="fas fa-bars text-xl"></i></button>
            <div class="flex items-center space-x-3">
                <div class="h-10 w-10 bg-emerald-900 rounded-xl flex items-center justify-center text-white font-black shadow-lg">IIG</div>
                <div class="hidden sm:block">
                    <h1 class="font-extrabold text-[10px] uppercase tracking-[0.2em] text-emerald-900 leading-tight">Strategic Terminal</h1>
                    <p id="officer-status" class="text-[8px] font-bold text-slate-400 uppercase mt-1">Sync: Authenticating...</p>
                </div>
            </div>
        </div>

        <div class="flex items-center space-x-3">
            <button onclick="toggleNotifications()" class="relative p-3 rounded-2xl bg-slate-50 border border-slate-200 hover:bg-white hover:border-emerald-500 transition-all group">
                <i class="fas fa-bell text-slate-500 group-hover:text-emerald-600"></i>
                <span id="notif-count" class="absolute -top-1 -right-1 hidden bg-red-600 text-white text-[8px] font-black px-1.5 py-0.5 rounded-full notif-pulse">0</span>
            </button>
            <div class="hidden md:flex items-center space-x-2 border-l pl-4">
                <button onclick="window.print()" class="p-3 text-slate-400 hover:text-emerald-600"><i class="fas fa-print"></i></button>
                <button onclick="auth.signOut().then(()=>location.reload())" class="p-3 text-slate-400 hover:text-red-500"><i class="fas fa-power-off"></i></button>
            </div>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        <aside id="sidebar-panel" class="fixed lg:static inset-y-0 left-0 w-[300px] md:w-[380px] bg-white border-r z-[1050] flex flex-col no-print drawer-transform -translate-x-full lg:translate-x-0">
            <div class="p-6 border-b space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-4 bg-slate-50 rounded-2xl border text-center">
                        <p class="text-[8px] font-black text-slate-400 uppercase mb-1">Global Nodes</p>
                        <h3 id="stat-members" class="text-xl font-black text-slate-800">0</h3>
                    </div>
                    <div class="p-4 bg-emerald-900 rounded-2xl text-white text-center shadow-lg">
                        <p class="text-[8px] font-black text-emerald-300 uppercase mb-1">Total Savings</p>
                        <h3 id="stat-total-gca" class="text-[10px] font-black">KSh 0</h3>
                    </div>
                </div>
                <input type="text" id="master-search" oninput="filterHierarchy()" placeholder="Scan Phone / Name..." class="w-full px-5 py-3.5 bg-slate-50 rounded-xl border-none text-[10px] font-bold uppercase outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div id="hierarchy-tree" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar"></div>
        </aside>

        <main id="main-content" class="flex-1 bg-[#f8fafc] overflow-y-auto p-4 md:p-8 no-scrollbar scroll-smooth relative">
            
            <div id="login-ui" class="max-w-md mx-auto bg-white rounded-[2.5rem] shadow-2xl border p-10 text-center mt-10 no-print animate-fade-in">
                <div class="w-20 h-20 bg-emerald-50 rounded-full flex items-center justify-center mx-auto mb-6">
                    <i class="fas fa-shield-check text-4xl text-emerald-600"></i>
                </div>
                <h2 class="text-2xl font-black uppercase text-slate-800 tracking-tight leading-none">Officer Access</h2>
                <form id="login-form" class="mt-8 space-y-4 text-left">
                    <input type="email" id="admin-email" placeholder="Terminal ID" class="w-full p-4 rounded-xl border bg-slate-50 font-bold" required>
                    <input type="password" id="admin-password" placeholder="PIN Code" class="w-full p-4 rounded-xl border bg-slate-50 font-bold" required>
                    <button type="submit" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest shadow-xl">Establish Link</button>
                </form>
            </div>

            <div id="member-dossier" class="hidden max-w-5xl mx-auto space-y-6 md:space-y-8 animate-fade pb-20">
                
                <div class="member-card p-6 md:p-10 flex flex-col md:flex-row items-center gap-8">
                    <div id="qrcode" class="p-2 bg-white border rounded-2xl shadow-sm no-print"></div>
                    <div class="flex-1 text-center md:text-left">
                        <p id="bio-location-path" class="text-[9px] font-black text-emerald-600 uppercase tracking-[0.3em] mb-2">---</p>
                        <h2 id="active-name" class="text-4xl md:text-6xl font-black uppercase tracking-tighter text-slate-900 leading-none mb-6">---</h2>
                        <div class="flex flex-wrap items-center justify-center md:justify-start gap-4">
                            <button onclick="speakBalance()" class="bg-slate-900 text-white px-8 py-4 rounded-xl text-[10px] font-black uppercase shadow-xl no-print active:scale-95 transition-all"><i class="fas fa-volume-up mr-2"></i> Somesha Salio</button>
                            <div class="text-left border-l-2 pl-4">
                                <p class="text-[8px] font-black text-slate-400 uppercase">Trust score</p>
                                <p id="trust-score" class="text-xl font-black text-emerald-600">0/100</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center md:text-right">
                        <p class="text-[10px] font-black text-slate-400 uppercase mb-1">Lifetime Savings</p>
                        <h2 id="active-grand-total" class="text-5xl md:text-7xl font-black text-emerald-600 tracking-tighter">KSh 0</h2>
                        <p id="yield-projection" class="text-[10px] font-black text-amber-600 mt-2 uppercase tracking-widest">---</p>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-msa">
                        <h4 class="text-[8px] font-black uppercase text-msa mb-2"><i class="fas fa-leaf mr-2"></i> MSA [66]</h4>
                        <input type="number" id="inp-msa" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-gff">
                        <h4 class="text-[8px] font-black uppercase text-gff mb-2"><i class="fas fa-gavel mr-2"></i> GFF [67]</h4>
                        <input type="number" id="inp-gff" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-gmf">
                        <h4 class="text-[8px] font-black uppercase text-gmf mb-2"><i class="fas fa-graduation-cap mr-2"></i> GMF [68]</h4>
                        <input type="number" id="inp-gmf" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-gsf">
                        <h4 class="text-[8px] font-black uppercase text-gsf mb-2"><i class="fas fa-house mr-2"></i> GSF [69]</h4>
                        <input type="number" id="inp-gsf" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-psa">
                        <h4 class="text-[8px] font-black uppercase text-psa mb-2"><i class="fas fa-wallet mr-2"></i> PSA [70]</h4>
                        <input type="number" id="inp-psa" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-fis">
                        <h4 class="text-[8px] font-black uppercase text-fis mb-2"><i class="fas fa-seedling mr-2"></i> FIS [71]</h4>
                        <input type="number" id="inp-fis" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-gca">
                        <h4 class="text-[8px] font-black uppercase text-gca mb-2"><i class="fas fa-university mr-2"></i> GCA [72]</h4>
                        <input type="number" id="inp-gca" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                    <div class="bg-white p-5 rounded-[2rem] border shadow-sm border-afs">
                        <h4 class="text-[8px] font-black uppercase text-afs mb-2"><i class="fas fa-couch mr-2"></i> AFS [73]</h4>
                        <input type="number" id="inp-afs" class="w-full text-2xl font-black outline-none bg-transparent">
                    </div>
                </div>

                <div class="bg-white p-8 md:p-12 rounded-[3rem] border shadow-sm space-y-10">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 border-b pb-8">
                        <h4 class="text-[11px] font-black uppercase text-slate-400 tracking-widest">Verification History</h4>
                        <button onclick="commitSync()" id="sync-btn" class="w-full md:w-auto bg-emerald-700 text-white font-black px-12 py-5 rounded-[2rem] uppercase text-[10px] tracking-widest shadow-2xl hover:bg-emerald-800 transition-all">Sync Strategic Packet</button>
                    </div>
                    <div id="audit-history-timeline" class="space-y-6"></div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6 pb-10">
                    <div class="bg-white p-8 rounded-[3rem] border space-y-6">
                        <p class="text-[9px] font-black uppercase text-slate-300">Biometric Signature</p>
                        <img id="view-sign" class="h-40 w-full object-contain bg-slate-50 rounded-2xl border grayscale p-4">
                        <div class="grid grid-cols-2 gap-4">
                            <img id="view-id-front" class="h-32 w-full object-cover rounded-xl border">
                            <img id="view-id-back" class="h-32 w-full object-cover rounded-xl border">
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[3rem] border flex flex-col justify-center space-y-6">
                        <div class="space-y-4">
                            <p class="flex justify-between text-[11px] font-bold uppercase tracking-widest text-slate-400">Village Hub: <span id="p-village" class="font-black text-emerald-800 uppercase">---</span></p>
                            <p class="flex justify-between text-[11px] font-bold uppercase tracking-widest text-slate-400">Mobile ID: <span id="p-phone" class="font-black text-slate-900">---</span></p>
                            <p class="flex justify-between text-[11px] font-bold uppercase tracking-widest text-slate-400">Email Node: <span id="p-email" class="font-black text-slate-500 lowercase">---</span></p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <div id="notif-panel" class="fixed inset-y-0 right-0 w-full md:w-[450px] bg-white shadow-2xl z-[2000] translate-x-full drawer-transform flex flex-col no-print border-l">
        <div class="p-6 bg-slate-900 text-white flex justify-between items-center">
            <div>
                <h3 class="font-black text-xs uppercase tracking-[0.2em]">Onboarding Queue</h3>
                <p class="text-[8px] font-bold text-emerald-400 uppercase mt-1">Strategic Verification Pending</p>
            </div>
            <button onclick="toggleNotifications()" class="w-10 h-10 rounded-full bg-white/10 flex items-center justify-center hover:bg-white/20 transition-all"><i class="fas fa-times"></i></button>
        </div>
        <div id="request-list" class="flex-1 overflow-y-auto p-4 space-y-4 bg-slate-100/50">
            </div>
    </div>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/60 backdrop-blur-sm z-[1040] hidden lg:hidden"></div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDG3C4wwetbVFHCNt3latkgM7-3ntOfFmg",
            authDomain: "help-me-up-70fcc.firebaseapp.com",
            databaseURL: "https://help-me-up-70fcc-default-rtdb.firebaseio.com",
            projectId: "help-me-up-70fcc",
            storageBucket: "help-me-up-70fcc.firebasestorage.app",
            messagingSenderId: "593893312398",
            appId: "1:593893312398:web:a982fca857289fc2f206df"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();

        let CACHE = { centers: {}, groups: {}, members: {}, audits: {} };
        let activeMemberId = null;
        const qrcode = new QRCode(document.getElementById("qrcode"), { width: 80, height: 80 });

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-ui').classList.add('hidden');
                document.getElementById('officer-status').innerText = `Officer: ${user.email.split('@')[0].toUpperCase()}`;
                startSync();
                listenForRequests();
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value)
                .catch(err => alert(err.message));
        };

        function startSync() {
            database.ref('organization/centers').on('value', s => { CACHE.centers = s.val() || {}; renderTree(); });
            database.ref('organization/groups').on('value', s => { CACHE.groups = s.val() || {}; renderTree(); });
            database.ref('records/members').on('value', s => { 
                CACHE.members = s.val() || {}; 
                renderTree(); 
                if(activeMemberId) populateDossier(activeMemberId);
            });
        }

        function renderTree() {
            const tree = document.getElementById('hierarchy-tree');
            tree.innerHTML = "";
            let sums = { global: 0, count: 0 };

            Object.entries(CACHE.centers).sort((a,b) => a[1].name.localeCompare(b[1].name)).forEach(([cId, center]) => {
                let cSum = 0;
                const groups = Object.entries(CACHE.groups).filter(([_, g]) => g.parentCenter === cId);
                const groupHTML = groups.map(([gId, group]) => {
                    let gSum = 0;
                    const members = Object.entries(CACHE.members).filter(([_, m]) => m.groupId === gId);
                    const memberHTML = members.map(([mId, m]) => {
                        sums.count++;
                        const total = calculatePacketTotal(m.financials);
                        gSum += total;
                        return `<div onclick="selectMember('${mId}')" class="p-4 flex justify-between items-center bg-white rounded-xl mb-1.5 border-l-4 border-transparent cursor-pointer hover:bg-emerald-50 transition ${activeMemberId === mId ? 'border-emerald-500 bg-emerald-50' : ''}">
                                    <span class="text-[10px] font-black uppercase text-slate-700">${m.name}</span>
                                    <span class="text-[10px] font-black text-emerald-600">KSh ${total.toLocaleString()}</span>
                                </div>`;
                    }).join('');
                    cSum += gSum;
                    return `<div class="mb-3 p-3 bg-slate-50/50 rounded-2xl border border-slate-100">
                                <div class="flex justify-between items-center p-2 cursor-pointer" onclick="toggleNode('g-${gId}')">
                                    <span class="text-[9px] font-black uppercase text-blue-600">${group.name} Node</span>
                                    <span class="text-[9px] font-bold text-slate-400">KSh ${gSum.toLocaleString()}</span>
                                </div>
                                <div id="g-${gId}" class="hidden mt-3">${memberHTML || '<p class="text-[8px] text-center italic py-2">Empty</p>'}</div>
                            </div>`;
                }).join('');

                sums.global += cSum;
                tree.innerHTML += `<div class="p-6 bg-white rounded-3xl border shadow-sm mb-4">
                                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleNode('c-${cId}')">
                                            <h3 class="font-black text-[11px] uppercase text-emerald-900">${center.name} Ward</h3>
                                            <span class="text-[11px] font-black text-emerald-700">KSh ${cSum.toLocaleString()}</span>
                                        </div>
                                        <div id="c-${cId}" class="hidden mt-6">${groupHTML}</div>
                                    </div>`;
            });
            document.getElementById('stat-members').innerText = sums.count;
            document.getElementById('stat-total-gca').innerText = `KSh ${sums.global.toLocaleString()}`;
        }

        async function selectMember(mId) {
            activeMemberId = mId;
            document.getElementById('member-dossier').classList.remove('hidden');
            if(window.innerWidth < 1024) toggleSidebar();
            renderTree(); populateDossier(mId);
        }

        async function populateDossier(mId) {
            const m = CACHE.members[mId];
            if(!m) return;

            document.getElementById('active-name').innerText = m.name;
            document.getElementById('p-phone').innerText = m.phone;
            document.getElementById('p-email').innerText = m.email || "---";
            document.getElementById('p-village').innerText = m.geo?.village || "NOT RECORDED";
            document.getElementById('bio-location-path').innerText = `${CACHE.centers[m.centerId]?.name || 'HUB'} > ${CACHE.groups[m.groupId]?.name || 'GROUP'}`;
            
            const f = m.financials || {};
            ['msa', 'gff', 'gmf', 'gsf', 'psa', 'fis', 'gca', 'afs'].forEach(k => document.getElementById(`inp-${k}`).value = f[k] || 0);
            
            const snap = await database.ref('records/audits').orderByChild('farmerPhone').equalTo(m.phone).once('value');
            let lifetimeSum = 0, audits = [];
            snap.forEach(child => { lifetimeSum += calculatePacketTotal(child.val().financials); audits.push(child.val()); });

            document.getElementById('active-grand-total').innerText = `KSh ${lifetimeSum.toLocaleString()}`;
            document.getElementById('yield-projection').innerText = `Harvest Estimate: KSh ${(f.fis * 3.5).toLocaleString()}`;
            document.getElementById('trust-score').innerText = `${Math.min(100, audits.length * 5)}/100`;

            let logHTML = audits.reverse().map(a => {
                const af = a.financials || {};
                return `
                    <div class="p-8 bg-slate-50 rounded-[2.5rem] border shadow-sm audit-box">
                        <div class="flex justify-between items-start border-b pb-4 mb-6">
                            <div>
                                <p class="text-[10px] font-black text-slate-900 uppercase">${new Date(a.timestamp).toLocaleString()}</p>
                                <p class="text-[8px] font-bold text-slate-400 mt-1 uppercase">Officer: ${a.officer.split('@')[0]}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-2xl font-black">KSh ${calculatePacketTotal(af).toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-4 text-[9px] font-black">
                            <div class="bg-white p-3 rounded-xl border border-emerald-100 text-emerald-600">MSA: ${af.msa||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-red-100 text-red-600">GFF: ${af.gff||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-sky-100 text-sky-600">GMF: ${af.gmf||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-blue-100 text-blue-600">GSF: ${af.gsf||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-purple-100 text-purple-600">PSA: ${af.psa||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-amber-100 text-amber-600">FIS: ${af.fis||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-emerald-900 text-emerald-900">GCA: ${af.gca||0}</div>
                            <div class="bg-white p-3 rounded-xl border border-pink-100 text-pink-600">AFS: ${af.afs||0}</div>
                        </div>
                    </div>`;
            }).join('');
            document.getElementById('audit-history-timeline').innerHTML = logHTML || '<p class="text-center py-20 opacity-30">No history found.</p>';
            
            document.getElementById('view-sign').src = m.signature || "";
            document.getElementById('view-id-front').src = m.idImages?.front || "";
            document.getElementById('view-id-back').src = m.idImages?.back || "";
            qrcode.makeCode(`IIG_SYNC_VALID_${mId}`);
        }

        async function commitSync() {
            if(!activeMemberId) return;
            const btn = document.getElementById('sync-btn');
            btn.disabled = true; btn.innerText = "Transmitting Packet...";
            const fin = {
                msa: parseFloat(document.getElementById('inp-msa').value || 0),
                gff: parseFloat(document.getElementById('inp-gff').value || 0),
                gmf: parseFloat(document.getElementById('inp-gmf').value || 0),
                gsf: parseFloat(document.getElementById('inp-gsf').value || 0),
                psa: parseFloat(document.getElementById('inp-psa').value || 0),
                fis: parseFloat(document.getElementById('inp-fis').value || 0),
                gca: parseFloat(document.getElementById('inp-gca').value || 0),
                afs: parseFloat(document.getElementById('inp-afs').value || 0),
                timestamp: Date.now()
            };
            try {
                await database.ref(`records/members/${activeMemberId}/financials`).set(fin);
                await database.ref('records/audits').push({
                    farmerPhone: CACHE.members[activeMemberId].phone,
                    officer: auth.currentUser.email,
                    timestamp: Date.now(),
                    financials: fin
                });
                alert("Strategic Synchronization Successful.");
            } catch (e) { alert(e.message); }
            btn.disabled = false; btn.innerText = "Sync Strategic Packet";
        }

        // Onboarding Logic
        function toggleNotifications() { document.getElementById('notif-panel').classList.toggle('translate-x-full'); }
        function toggleSidebar() { document.getElementById('sidebar-panel').classList.toggle('-translate-x-full'); document.getElementById('sidebar-overlay')?.classList.toggle('hidden'); }
        function toggleNode(id) { document.getElementById(id).classList.toggle('hidden'); }
        function calculatePacketTotal(f) { return f ? (Object.values(f).filter(v => typeof v === 'number').reduce((a, b) => a + b, 0)) : 0; }
        
        function listenForRequests() {
            const paths = ['requests/onboarding', 'requests/cgt_onboarding'];
            paths.forEach(path => {
                database.ref(path).on('value', snapshot => {
                    renderRequestQueue(snapshot.val(), path);
                });
            });
        }

        function renderRequestQueue(requests, path) {
            const container = document.getElementById('request-list');
            const badge = document.getElementById('notif-count');
            if (!requests) {
                container.innerHTML = `<div class="text-center py-20 opacity-30 font-black uppercase text-[10px]">Queue Clear</div>`;
                badge.classList.add('hidden');
                return;
            }
            const entries = Object.entries(requests);
            badge.innerText = entries.length; badge.classList.remove('hidden');
            container.innerHTML = entries.map(([uid, data]) => `
                <div class="bg-white rounded-3xl p-5 border shadow-sm border-l-4 ${data.role === 'cgt' ? 'border-indigo-500' : 'border-emerald-500'}">
                    <div class="flex justify-between items-start mb-4">
                        <div>
                            <span class="text-[8px] font-black px-2 py-0.5 rounded-full bg-slate-100 text-slate-500 uppercase">${data.role}</span>
                            <h4 class="font-black text-slate-800 text-sm mt-1">${data.name}</h4>
                        </div>
                    </div>
                    <div class="grid grid-cols-2 gap-2 mb-4">
                        <img src="${data.idFront}" class="h-24 w-full object-cover rounded-xl border cursor-pointer" onclick="window.open(this.src)">
                        <img src="${data.idBack}" class="h-24 w-full object-cover rounded-xl border cursor-pointer" onclick="window.open(this.src)">
                    </div>
                    <div class="flex gap-2">
                        <button onclick="approveRequest('${uid}', '${path}')" class="flex-1 bg-emerald-600 text-white text-[9px] font-black py-3 rounded-xl uppercase tracking-widest">Approve</button>
                        <button onclick="rejectRequest('${uid}', '${path}')" class="px-4 text-red-500 text-[9px] font-black hover:bg-red-50 rounded-xl">Reject</button>
                    </div>
                </div>`).join('');
        }

        async function approveRequest(uid, path) {
            if (!confirm("Authorize this node?")) return;
            try {
                const snap = await database.ref(`${path}/${uid}`).once('value');
                const data = snap.val();
                const newMember = {
                    name: data.name, phone: data.phone, email: data.email, role: data.role, geo: data.geo,
                    idImages: { front: data.idFront, back: data.idBack },
                    financials: { msa:0, gff:0, gmf:0, gsf:0, psa:0, fis:0, gca:0, afs:0 },
                    onboardedAt: Date.now()
                };
                if (data.personPhoto) newMember.personPhoto = data.personPhoto;
                const updates = {};
                updates[`records/members/${uid}`] = newMember;
                updates[`${path}/${uid}`] = null;
                await database.ref().update(updates);
                alert("Authorization Successful.");
            } catch (e) { alert(e.message); }
        }

        async function rejectRequest(uid, path) { if (confirm("Decline entry?")) await database.ref(`${path}/${uid}`).remove(); }
        
        function speakBalance() {
            const m = CACHE.members[activeMemberId];
            const msg = new SpeechSynthesisUtterance(`Habari ${m.name}. Salio lako la jumla ni shilingi ya Kenya, ${document.getElementById('active-grand-total').innerText}. Asanti.`);
            msg.lang = 'sw-KE'; window.speechSynthesis.speak(msg);
        }

        function filterHierarchy() {
            const term = document.getElementById('master-search').value.toLowerCase();
            document.querySelectorAll('#hierarchy-tree div[onclick^="selectMember"]').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>