<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Global Registration | IIG SMART FARMERS</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&family=Plus+Jakarta+Sans:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        :root {
            --brand-emerald: #065f46;
            --brand-slate: #0f172a;
        }

        body { 
            font-family: 'Inter', sans-serif; 
            background: #f8fafc; 
            color: var(--brand-slate);
            scroll-behavior: smooth;
        }

        .fintech-font { font-family: 'Plus Jakarta Sans', sans-serif; }

        /* Glassmorphism & UI Transitions */
        .glass-nav {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
        }

        .dropdown-menu {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            transform: translateY(10px);
            opacity: 0;
            visibility: hidden;
        }
        .group:hover .dropdown-menu {
            transform: translateY(0);
            opacity: 1;
            visibility: visible;
        }

        .form-card {
            background: white;
            border: 1px solid rgba(226, 232, 240, 0.8);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.05);
            border-radius: 1.5rem;
            transition: all 0.3s ease;
        }

        /* Input Styling */
        .input-field {
            @apply w-full px-5 py-3.5 rounded-xl bg-slate-50 border border-slate-200 outline-none transition-all duration-200;
            font-weight: 500;
        }
        .input-field:focus { @apply bg-white border-emerald-500 ring-4 ring-emerald-500/10; }

        .label-text { @apply text-[11px] font-bold uppercase tracking-wider text-slate-500 mb-2 block ml-1; }

        /* Step Indicators */
        .step-circle {
            @apply h-8 w-8 rounded-lg flex items-center justify-center text-xs font-bold transition-all duration-300;
        }
        .active-step { @apply bg-emerald-600 text-white shadow-lg; }

        #user-sidebar { transition: transform 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .gradient-light { background: linear-gradient(135deg, #f0fdf4 0%, #ffffff 100%); }
        .hero-pattern { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
    </style>
</head>
<body class="overflow-x-hidden">

    <nav class="glass-nav shadow-md border-b border-green-100 sticky top-0 z-[100]">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex justify-between h-20 items-center">
                <div class="flex-shrink-0 flex items-center">
                    <a href="index.html" class="flex items-center transition hover:opacity-80">
                        <img src="IIG LOGO.jpeg" alt="IIG Logo" class="h-12 md:h-14 w-auto object-contain">
                    </a>
                </div>

                <div class="hidden md:flex space-x-6 items-center">
                    <a href="index.html" class="text-green-700 font-bold text-sm tracking-wide">Home</a>
                    <a id="nav-admin" href="admin.html" class="hidden text-red-600 font-bold text-xs uppercase"><i class="fas fa-shield-alt mr-1"></i> Admin</a>
                    <a id="nav-cgt" href="cgt access.html" class="hidden text-blue-600 font-bold text-xs uppercase"><i class="fas fa-chart-pie mr-1"></i> CGT Console</a>

                    <div class="relative group h-20 flex items-center">
                        <button class="flex items-center text-gray-600 font-medium text-sm uppercase tracking-widest">
                            Explore <i class="fas fa-chevron-down ml-2 text-[10px]"></i>
                        </button>
                        <div class="dropdown-menu absolute top-full left-0 w-80 bg-white shadow-2xl rounded-b-2xl border-t-4 border-green-600 z-[110] overflow-hidden">
                            <div class="py-2">
                                <p class="px-6 py-2 text-[9px] font-black text-slate-300 uppercase tracking-widest">Community</p>
                                <a href="about us.html" class="flex items-center px-6 py-3 text-sm text-gray-700 hover:bg-green-50 transition">About Mission</a>
                                <a href="services.html" class="flex items-center px-6 py-3 text-sm text-gray-700 hover:bg-green-50 transition">Farm Services</a>
                                <a href="help.html" class="flex items-center px-6 py-3 text-sm text-gray-700 hover:bg-green-50 transition">Help Desk</a>
                            </div>
                        </div>
                    </div>

                    <button onclick="toggleSidebar()" class="flex items-center space-x-2 bg-slate-100 p-1.5 pr-4 rounded-full border border-slate-200 hover:bg-green-50 transition">
                        <div class="h-8 w-8 bg-green-600 rounded-full flex items-center justify-center text-white text-xs"><i class="fas fa-user"></i></div>
                        <span id="user-name-tag" class="text-[10px] font-black uppercase tracking-tighter text-slate-600">Guest</span>
                    </button>
                </div>

                <div class="md:hidden flex items-center">
                    <button id="menu-btn" class="text-green-800 p-2"><i id="menu-icon" class="fas fa-bars text-2xl"></i></button>
                </div>
            </div>
        </div>
    </nav>

    <header class="gradient-light relative py-16 md:py-24 hero-pattern overflow-hidden">
        <div class="max-w-7xl mx-auto px-4 text-center">
            <h1 class="text-4xl md:text-6xl font-black text-green-900 mb-4">
                Initialize <span class="text-green-600">Enrollment</span>
            </h1>
            <p class="text-lg text-green-800 opacity-90 font-medium max-w-2xl mx-auto">
                Securely establish your digital identity within the IIG Smart Farmers financial network.
            </p>
        </div>
    </header>

    <main class="max-w-4xl mx-auto py-12 px-4 relative z-10 -mt-10">
        <form id="master-enrollment-form" class="space-y-8 fintech-font">
            
            <section class="form-card p-8">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="step-circle active-step">01</div>
                    <div>
                        <h3 class="font-bold text-slate-900 uppercase text-sm tracking-wider">Access Level</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Define your operational identity</p>
                    </div>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="relative cursor-pointer group" onclick="setRole('farmer')">
                        <input type="radio" name="role" id="role-farmer" value="farmer" class="hidden peer" checked>
                        <label for="role-farmer" class="block p-5 border-2 border-slate-100 rounded-2xl peer-checked:border-emerald-500 peer-checked:bg-emerald-50 transition-all cursor-pointer">
                            <i class="fas fa-tractor text-slate-400 group-hover:text-emerald-500 mb-3 text-xl"></i>
                            <p class="font-bold text-sm">Standard Member</p>
                            <p class="text-[10px] text-slate-400 font-medium">Farmer / Agricultural Producer</p>
                        </label>
                    </div>
                    <div class="relative cursor-pointer group" onclick="setRole('cgt')">
                        <input type="radio" name="role" id="role-cgt" value="cgt" class="hidden peer">
                        <label for="role-cgt" class="block p-5 border-2 border-slate-100 rounded-2xl peer-checked:border-indigo-500 peer-checked:bg-indigo-50 transition-all cursor-pointer">
                            <i class="fas fa-user-check text-slate-400 group-hover:text-indigo-500 mb-3 text-xl"></i>
                            <p class="font-bold text-sm">CGT Field Officer</p>
                            <p class="text-[10px] text-slate-400 font-medium">Financial Auditing & Support</p>
                        </label>
                    </div>
                </div>
            </section>

            <section class="form-card p-8">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="step-circle active-step">02</div>
                    <div>
                        <h3 class="font-bold text-slate-900 uppercase text-sm tracking-wider">Core Credentials</h3>
                        <p class="text-[10px] text-slate-400 font-bold uppercase">Legal Identification</p>
                    </div>
                </div>
                <div class="grid md:grid-cols-2 gap-6">
                    <div class="md:col-span-2">
                        <label class="label-text">Full Legal Name</label>
                        <input type="text" id="m-name" required class="input-field" placeholder="Full Name as per National ID">
                    </div>
                    <div><label class="label-text">Phone Number</label><input type="tel" id="m-phone" required class="input-field" placeholder="07..."></div>
                    <div><label class="label-text">Email Address</label><input type="email" id="m-email" required class="input-field" placeholder="name@domain.com"></div>
                    <div class="md:col-span-2"><label class="label-text">Create Password</label><input type="password" id="m-password" required class="input-field" placeholder="••••••••" minlength="8"></div>
                </div>
            </section>

            <section id="cgt-exclusive-fields" class="hidden form-card p-8 border-l-4 border-indigo-500 bg-indigo-50/20">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="step-circle bg-indigo-600 text-white">03</div>
                    <h3 class="font-bold text-indigo-900 uppercase text-sm">Personnel Deployment</h3>
                </div>
                <div class="flex flex-col md:flex-row gap-8 items-center">
                    <div class="relative h-32 w-32 rounded-2xl bg-white border-2 border-dashed border-indigo-200 flex items-center justify-center overflow-hidden">
                        <input type="file" id="person-image-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(this, 'preview-person')">
                        <img id="preview-person" class="absolute inset-0 w-full h-full object-cover hidden">
                        <i class="fas fa-camera text-indigo-200 text-2xl"></i>
                    </div>
                    <div class="w-full">
                        <label class="label-text text-indigo-600">Nearest Primary School</label>
                        <input type="text" id="cgt-school" class="input-field border-indigo-100" placeholder="e.g. Kakamega Central">
                    </div>
                </div>
            </section>

            <section class="form-card p-8">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="step-circle active-step">04</div>
                    <h3 class="font-bold text-slate-900 uppercase text-sm">Geographical Node</h3>
                </div>
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4">
                    <div><label class="label-text">County</label><input type="text" id="geo-county" required class="input-field"></div>
                    <div><label class="label-text">Sub-County</label><input type="text" id="geo-subcounty" required class="input-field"></div>
                    <div><label class="label-text">Ward</label><input type="text" id="geo-location" required class="input-field"></div>
                    <div><label class="label-text">Village</label><input type="text" id="geo-village" required class="input-field"></div>
                </div>
            </section>

            <section class="form-card p-8">
                <div class="flex items-center space-x-4 mb-8">
                    <div class="step-circle active-step">05</div>
                    <h3 class="font-bold text-slate-900 uppercase text-sm">Document Verification</h3>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                    <div class="relative h-48 rounded-2xl bg-slate-50 border-2 border-dashed border-slate-200 flex flex-col items-center justify-center overflow-hidden cursor-pointer group hover:bg-emerald-50 transition-all">
                        <input type="file" id="id-front-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(this, 'preview-front')">
                        <img id="preview-front" class="absolute inset-0 w-full h-full object-cover hidden">
                        <i class="fas fa-id-card text-3xl text-slate-300 group-hover:text-emerald-500 mb-2"></i>
                        <p class="text-[9px] font-bold text-slate-400">ID FRONT SCAN</p>
                    </div>
                    <div class="relative h-48 rounded-2xl bg-slate-50 border-2 border-dashed border-slate-200 flex flex-col items-center justify-center overflow-hidden cursor-pointer group hover:bg-emerald-50 transition-all">
                        <input type="file" id="id-back-file" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer z-10" onchange="previewImage(this, 'preview-back')">
                        <img id="preview-back" class="absolute inset-0 w-full h-full object-cover hidden">
                        <i class="fas fa-barcode text-3xl text-slate-300 group-hover:text-emerald-500 mb-2"></i>
                        <p class="text-[9px] font-bold text-slate-400">ID REVERSE SCAN</p>
                    </div>
                </div>
            </section>

            <button type="submit" id="submit-btn" class="w-full bg-slate-900 text-white font-bold py-5 rounded-2xl shadow-xl hover:bg-emerald-700 transition-all duration-300 flex items-center justify-center space-x-3">
                <span class="tracking-widest uppercase text-sm">Initialize Secure Enrollment</span>
                <i class="fas fa-shield-alt text-xs"></i>
            </button>
        </form>
    </main>

    <div id="sidebar-overlay" onclick="toggleSidebar()" class="fixed inset-0 bg-slate-900/40 backdrop-blur-sm z-[250] hidden opacity-0 transition-opacity duration-300"></div>
    <div id="user-sidebar" class="fixed inset-y-0 right-0 w-80 bg-white shadow-2xl z-[300] translate-x-full border-l border-slate-100 overflow-y-auto">
        <div class="p-8 border-b flex justify-between items-center bg-slate-50">
            <div>
                <h3 class="font-black text-slate-900 text-sm uppercase tracking-widest">Farmer Terminal</h3>
                <p id="role-badge" class="text-[9px] font-bold text-green-600 uppercase mt-2 tracking-widest">Guest Mode</p>
            </div>
            <button onclick="toggleSidebar()" class="text-slate-400 hover:text-red-500"><i class="fas fa-times"></i></button>
        </div>
        <div class="p-8 space-y-6">
            <a href="register.html" class="flex items-center space-x-4 p-4 rounded-2xl text-slate-600 font-bold text-sm hover:bg-slate-50 transition">
                <i class="fas fa-users w-5"></i> <span>Become Members</span>
            </a>
            <button onclick="logout()" class="w-full bg-slate-900 text-white font-black py-4 rounded-xl uppercase text-[10px] tracking-widest">Terminate Session</button>
        </div>
    </div>

    <footer class="bg-gray-900 py-20 text-gray-400">
        <div class="max-w-7xl mx-auto px-4 grid md:grid-cols-3 gap-12 border-b border-gray-800 pb-12 mb-8">
            <div class="space-y-6">
                <img src="IIG LOGO.jpeg" alt="Logo" class="h-14 filter brightness-0 invert opacity-60">
                <p class="text-xs leading-relaxed max-w-sm">Providing financial support to small-scale farmers in marginalized Kenyan communities.</p>
            </div>
            <div>
                <h4 class="text-white font-black text-xs uppercase tracking-widest mb-6">Support</h4>
                <ul class="space-y-4 text-[11px]">
                    <li class="flex items-center space-x-3"><i class="fas fa-envelope text-green-500"></i> <span>iigsmartfarmersltd@gmail.com</span></li>
                    <li class="flex items-center space-x-3"><i class="fas fa-phone text-green-500"></i> <span>+254 113 271 924</span></li>
                </ul>
            </div>
            <div class="text-center md:text-right">
                <p class="text-[9px] font-black uppercase tracking-[0.4em] opacity-40">&copy; 2026 IIG Smart Farmers Limited.</p>
            </div>
        </div>
    </footer>

    <script>
        // FIREBASE CONFIG
        const firebaseConfig = {
            apiKey: "AIzaSyDG3C4wwetbVFHCNt3latkgM7-3ntOfFmg",
            authDomain: "help-me-up-70fcc.firebaseapp.com",
            databaseURL: "https://help-me-up-70fcc-default-rtdb.firebaseio.com",
            projectId: "help-me-up-70fcc",
            storageBucket: "help-me-up-70fcc.firebasestorage.app",
            messagingSenderId: "593893312398",
            appId: "1:593893312398:web:a982fca857289fc2f206df"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();

        let images = { front: "", back: "", person: "" };

        // SIDEBAR & AUTH LOGIC
        function toggleSidebar() {
            const sidebar = document.getElementById('user-sidebar');
            const overlay = document.getElementById('sidebar-overlay');
            const isClosed = sidebar.classList.contains('translate-x-full');
            if (isClosed) {
                sidebar.classList.remove('translate-x-full');
                overlay.classList.remove('hidden');
                setTimeout(() => overlay.classList.add('opacity-100'), 10);
            } else {
                sidebar.classList.add('translate-x-full');
                overlay.classList.remove('opacity-100');
                setTimeout(() => overlay.classList.add('hidden'), 300);
            }
        }

        auth.onAuthStateChanged(async (user) => {
            if (user) {
                const snapshot = await database.ref('users/' + user.uid).get();
                const userData = snapshot.val();
                if(userData) document.getElementById('user-name-tag').innerText = userData.name.split(' ')[0];
                document.getElementById('role-badge').innerText = userData?.role?.toUpperCase() || "MEMBER";
            }
        });

        // FORM LOGIC
        function setRole(role) {
            const cgtSection = document.getElementById('cgt-exclusive-fields');
            role === 'cgt' ? cgtSection.classList.remove('hidden') : cgtSection.classList.add('hidden');
        }
        // Add to auth.onAuthStateChanged success block
database.ref('system_settings/maintenance_mode').on('value', snap => {
    if (snap.val() === true && !['iigsmartfarmersltd@gmail.com', 'delstarfordisaiah@gmail.com'].includes(auth.currentUser.email)) {
        document.body.innerHTML = `
            <div class="min-h-screen flex flex-col items-center justify-center bg-slate-950 text-white p-10 text-center">
                <i class="fas fa-tools text-6xl text-green-400 mb-6 animate-bounce"></i>
                <h1 class="text-3xl font-black uppercase tracking-widest">System Maintenance</h1>
                <p class="mt-4 text-slate-400 text-xs uppercase tracking-widest leading-loose">Access to the Strategic Terminal is currently restricted.<br>Synchronizing global ledger security. Please stand by.</p>
            </div>`;
    }
});
        function initializePresence(email) {
    const statusRef = database.ref('/status/' + auth.currentUser.uid);
    database.ref('.info/connected').on('value', snap => {
        if (snap.val() === false) return;
        // Sets status to online when connected
        statusRef.onDisconnect().set({ state: 'offline', last_changed: firebase.database.ServerValue.TIMESTAMP, email: email, kick: false })
        .then(() => {
            statusRef.set({ state: 'online', last_changed: firebase.database.ServerValue.TIMESTAMP, email: email, kick: false });
        });
    });
}
        function previewImage(input, previewId) {
            if (input.files && input.files[0]) {
                const reader = new FileReader();
                reader.onload = (e) => {
                    const img = document.getElementById(previewId);
                    img.src = e.target.result;
                    img.classList.remove('hidden');
                    if(previewId === 'preview-front') images.front = e.target.result;
                    if(previewId === 'preview-back') images.back = e.target.result;
                    if(previewId === 'preview-person') images.person = e.target.result;
                };
                reader.readAsDataURL(input.files[0]);
            }
        }
document.getElementById('master-enrollment-form').onsubmit = async (e) => {
    e.preventDefault();
    const btn = document.getElementById('submit-btn');
    const activeRole = document.querySelector('input[name="role"]:checked').value;

    // Check for required ID documents
    if(!images.front || !images.back) return alert("Please upload both ID Front and Back scans.");
    if(activeRole === 'cgt' && !images.person) return alert("Field Officers must upload a profile photo.");

    btn.disabled = true;
    btn.innerHTML = `<i class="fas fa-circle-notch fa-spin mr-3"></i> Syncing Node...`;

    try {
        const email = document.getElementById('m-email').value;
        const password = document.getElementById('m-password').value;
        
        // 1. Create Auth User
        const userCredential = await auth.createUserWithEmailAndPassword(email, password);
        const uid = userCredential.user.uid;

        // 2. Prepare Data Packet for Admin Approval
        // We match the keys expected by admin.html (name, phone, geo, idFront, etc.)
        const dataPacket = {
            uid: uid,
            name: document.getElementById('m-name').value.toUpperCase(),
            phone: document.getElementById('m-phone').value,
            email: email,
            role: activeRole,
            geo: { 
                county: document.getElementById('geo-county').value, 
                subcounty: document.getElementById('geo-subcounty').value,
                location: document.getElementById('geo-location').value, // Ward
                village: document.getElementById('geo-village').value 
            },
            idFront: images.front,
            idBack: images.back,
            timestamp: Date.now(),
            status: 'pending'
        };

        // Add CGT specific fields if needed
        if(activeRole === 'cgt') {
            dataPacket.personPhoto = images.person;
            dataPacket.geo.nearestSchool = document.getElementById('cgt-school').value;
        }

        // 3. Route to the correct Request path for Admin Notification
        const requestPath = activeRole === 'cgt' ? 'requests/cgt_onboarding' : 'requests/onboarding';
        
        // Push to the requests queue so admin.html listeners pick it up
        await database.ref(`${requestPath}/${uid}`).set(dataPacket);

        alert("Enrollment request transmitted! Your account is pending Admin verification.");
        window.location.href = "index.html";
        
    } catch (error) {
        alert("Enrollment Error: " + error.message);
        btn.disabled = false;
        btn.innerHTML = `<span class="tracking-widest uppercase text-sm">Initialize Secure Enrollment</span> <i class="fas fa-shield-alt text-xs"></i>`;
    }
};
        function logout() { auth.signOut().then(() => window.location.href = "login.html"); }
    </script>
</body>
</html>