<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Network Feed | IIG Smart Farmers</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f0f2f5; }
        .post-card { transition: transform 0.2s ease, box-shadow 0.2s ease; }
        .post-card:hover { box-shadow: 0 10px 25px -5px rgba(0, 0, 0, 0.1); }
        ::-webkit-scrollbar { width: 6px; }
        ::-webkit-scrollbar-thumb { background: #cbd5e1; border-radius: 10px; }
        .liked { color: #ef4444 !important; font-weight: 900; }
    </style>
</head>
<body class="min-h-screen text-slate-900 pb-20">

    <nav class="bg-white/95 backdrop-blur-md border-b border-slate-200 sticky top-0 z-[100] px-4 py-3">
        <div class="max-w-5xl mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-3">
                <img src="IIG LOGO.jpeg" alt="IIG" class="h-9 w-9 rounded-lg shadow-sm">
                <div>
                    <h1 class="font-black text-[11px] uppercase tracking-widest text-green-900 leading-none">IIG Network</h1>
                    <p class="text-[8px] font-bold text-slate-400 mt-1 uppercase tracking-tighter flex items-center">
                        <span class="h-1.5 w-1.5 rounded-full bg-green-500 mr-1.5 animate-pulse"></span> Intelligence Feed
                    </p>
                </div>
            </div>

            <div class="flex items-center space-x-4">
                <a href="index.html" class="text-[10px] font-black uppercase text-slate-500 hover:text-green-700 transition">Portal Home</a>
                <div id="admin-controls" class="hidden flex items-center space-x-2">
                    <span class="bg-slate-900 text-green-400 px-3 py-1 rounded-full text-[8px] font-black uppercase tracking-widest border border-slate-700">Master Access</span>
                    <a href="post.html" class="bg-green-600 text-white px-3 py-1.5 rounded-full text-[9px] font-black uppercase tracking-widest hover:bg-green-700 transition shadow-md">+ New Post</a>
                </div>
            </div>
        </div>
    </nav>

    <header class="bg-white border-b border-slate-200 py-10 mb-8">
        <div class="max-w-2xl mx-auto px-4 text-center">
            <h2 class="text-3xl font-black tracking-tighter text-slate-900 uppercase leading-none">Activity Hub</h2>
            <p class="text-slate-500 text-sm mt-3 font-medium uppercase tracking-widest text-[10px]">Official Intelligence Broadcasts</p>
        </div>
    </header>

    <main class="max-w-2xl mx-auto px-4">
        <div id="loader" class="text-center py-20">
            <i class="fas fa-circle-notch fa-spin text-3xl text-green-600"></i>
            <p class="mt-4 text-[10px] font-black text-slate-400 uppercase tracking-widest">Syncing Feed Data...</p>
        </div>

        <div id="events-feed" class="space-y-8"></div>
    </main>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDG3C4wwetbVFHCNt3latkgM7-3ntOfFmg",
            authDomain: "help-me-up-70fcc.firebaseapp.com",
            databaseURL: "https://help-me-up-70fcc-default-rtdb.firebaseio.com",
            projectId: "help-me-up-70fcc",
            storageBucket: "help-me-up-70fcc.firebasestorage.app",
            messagingSenderId: "593893312398",
            appId: "1:593893312398:web:a982fca857289fc2f206df"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const database = firebase.database();

        const adminWhitelist = ['iigsmartfarmersltd@gmail.com', 'delstarfordisaiah@gmail.com'];
        let isAdmin = false;

        auth.onAuthStateChanged(user => {
            if (user && adminWhitelist.includes(user.email)) {
                isAdmin = true;
                document.getElementById('admin-controls').classList.remove('hidden');
            }
            fetchPosts();
        });

        function fetchPosts() {
            database.ref('activities').on('value', (snapshot) => {
                const feed = document.getElementById('events-feed');
                document.getElementById('loader').classList.add('hidden');
                feed.innerHTML = "";
                const data = snapshot.val();
                if (!data) return;
                Object.keys(data).reverse().forEach(key => {
                    feed.innerHTML += renderPost(key, data[key]);
                });
            });
        }

        function renderPost(id, data) {
            const displayImg = data.media ? data.media : 'IIG LOGO.jpeg';
            const comments = data.comments ? Object.values(data.comments) : [];
            const commentHtml = comments.map(c => `
                <div class="bg-white p-3 rounded-2xl mb-2 border border-slate-100 shadow-sm">
                    <p class="text-[9px] font-black text-green-700 uppercase leading-none mb-1">${c.user.split('@')[0]}</p>
                    <p class="text-[12px] text-slate-600 font-medium leading-tight">${c.text}</p>
                </div>
            `).join('');

            const adminTools = isAdmin ? `
                <div class="bg-red-50 px-4 py-2 flex justify-between items-center border-t border-red-100">
                    <span class="text-[8px] font-black text-red-300 uppercase tracking-widest italic">Admin Security override</span>
                    <button onclick="deletePost('${id}')" class="text-[9px] font-black text-red-500 uppercase hover:text-red-700 transition">
                        <i class="fas fa-trash-alt mr-1"></i> Purge From Hub
                    </button>
                </div>` : "";

            return `
                <div class="bg-white rounded-[2rem] shadow-sm border border-slate-200 overflow-hidden post-card" id="post-${id}">
                    <div class="p-5 flex items-center space-x-3">
                        <div class="h-10 w-10 bg-green-900 rounded-full flex items-center justify-center text-white font-bold text-xs">IIG</div>
                        <div>
                            <h4 class="text-[13px] font-black uppercase text-slate-800">IIG Smart Farmers</h4>
                            <p class="text-[10px] text-slate-400 font-bold uppercase">${data.category || 'Announcement'}</p>
                        </div>
                    </div>
                    <div class="px-6 pb-4">
                        <h3 class="text-lg font-black text-slate-900 leading-tight mb-2">${data.title}</h3>
                        <p class="text-[13px] text-slate-600 leading-relaxed">${data.description}</p>
                    </div>
                    <img src="${displayImg}" class="w-full border-y border-slate-100 object-cover max-h-[450px]">
                    
                    <div class="px-6 py-4 flex items-center justify-between border-b border-slate-50 bg-white">
                        <div class="flex space-x-10 text-slate-400">
                            <div onclick="toggleLike(this)" class="flex items-center cursor-pointer hover:text-red-500 transition group">
                                <i class="far fa-heart text-xl mr-2 group-hover:scale-110"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest">Like</span>
                            </div>
                            <div onclick="toggleCommentBox('${id}')" class="flex items-center cursor-pointer hover:text-blue-500 transition group">
                                <i class="far fa-comment text-xl mr-2 group-hover:scale-110"></i>
                                <span class="text-[10px] font-black uppercase tracking-widest">Comment (${comments.length})</span>
                            </div>
                        </div>
                        <span class="text-[8px] font-black uppercase text-slate-300 tracking-[0.2em]">Verified Node</span>
                    </div>

                    <div id="comment-box-${id}" class="hidden p-6 bg-slate-50 border-t">
                        <div class="max-h-60 overflow-y-auto custom-scrollbar mb-4 space-y-1">
                            ${commentHtml || '<p class="text-[10px] text-slate-400 text-center uppercase tracking-widest py-4">No records found</p>'}
                        </div>
                        <div class="flex items-center space-x-3 bg-white p-2 rounded-full border shadow-inner">
                            <input type="text" id="input-${id}" placeholder="Type comment..." class="flex-1 bg-transparent px-4 py-1 text-sm outline-none">
                            <button onclick="sendComment('${id}')" class="bg-green-600 text-white px-5 py-2 rounded-full text-[10px] font-black uppercase shadow-md active:scale-95 transition">Send</button>
                        </div>
                    </div>
                    ${adminTools}
                </div>
            `;
        }

        function toggleLike(el) {
            const icon = el.querySelector('i');
            icon.classList.toggle('fas');
            icon.classList.toggle('far');
            el.classList.toggle('liked');
        }

        function toggleCommentBox(id) {
            document.getElementById(`comment-box-${id}`).classList.toggle('hidden');
        }

        async function sendComment(postId) {
            const input = document.getElementById(`input-${postId}`);
            const text = input.value.trim();
            const user = auth.currentUser;
            if (!text || !user) return;

            const commentData = {
                text: text,
                user: user.email,
                timestamp: new Date().toISOString()
            };

            try {
                await database.ref(`activities/${postId}/comments`).push(commentData);
                input.value = "";
            } catch (err) { alert(err.message); }
        }

        function deletePost(id) {
            const user = auth.currentUser;
            if (!user || !adminWhitelist.includes(user.email)) {
                alert("Security Error: Master Access Required.");
                return;
            }
            if (confirm("ADMIN OVERRIDE: Permanently delete this event from the feed?")) {
                database.ref('activities/' + id).remove()
                    .then(() => alert("Data packet purged."))
                    .catch(e => alert(e.message));
            }
        }
    </script>
</body>
</html>