<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>CGT Dashboard | IIG SMART FARMERS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/exif-js/2.3.0/exif.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;900&display=swap');
        body { font-family: 'Inter', sans-serif; background-color: #f8fafc; scroll-behavior: smooth; }
        
        .gradient-dark { background: linear-gradient(135deg, #064e3b 0%, #022c22 100%); }
        .hero-pattern { background-image: url('https://www.transparenttextures.com/patterns/cubes.png'); }
        
        /* Node Styling */
        .center-node { border-left: 6px solid #10b981; } 
        .group-node { border-left: 5px solid #3b82f6; } 
        .member-node { border-left: 3px solid #cbd5e1; transition: all 0.2s; cursor: pointer; }
        .member-node:hover { border-color: #10b981; transform: translateX(4px); background-color: #f0fdf4; }
        .active-node { border-color: #10b981 !important; background-color: #f0fdf4 !important; box-shadow: inset 0 0 0 2px #10b981; }

        /* Forensic Animations */
        .fraud-alert { animation: shake 0.5s cubic-bezier(.36,.07,.19,.97) both; border: 2px solid #ef4444 !important; }
        @keyframes shake {
            10%, 90% { transform: translate3d(-1px, 0, 0); }
            20%, 80% { transform: translate3d(2px, 0, 0); }
            30%, 50%, 70% { transform: translate3d(-4px, 0, 0); }
            40%, 60% { transform: translate3d(4px, 0, 0); }
        }

        .custom-scrollbar::-webkit-scrollbar { width: 5px; }
        .custom-scrollbar::-webkit-scrollbar-thumb { background: #10b981; border-radius: 10px; }
        
        .glass-panel { background: rgba(255, 255, 255, 0.8); backdrop-filter: blur(12px); border: 1px solid rgba(255, 255, 255, 0.3); }
    </style>
</head>
<body class="min-h-screen text-slate-900">

    <nav class="bg-white/90 backdrop-blur-xl border-b border-slate-200 sticky top-0 z-[100] px-6 py-3">
        <div class="max-w-[1600px] mx-auto flex justify-between items-center">
            <div class="flex items-center space-x-4">
                <div class="h-11 w-11 bg-green-900 rounded-2xl flex items-center justify-center text-white font-black shadow-xl ring-4 ring-green-900/10">IIG</div>
                <div>
                    <h1 class="font-black text-sm uppercase tracking-tighter text-green-900 leading-none">Strategic CGT Terminal</h1>
                    <p class="text-[9px] font-bold text-slate-400 mt-1 uppercase tracking-[0.2em]">Global Financial Shield </p>
                </div>
            </div>
            
            <div id="auth-status" class="hidden flex items-center space-x-3">
                <button onclick="openOnboard()" class="bg-green-600 hover:bg-green-700 text-white text-[10px] font-black px-5 py-2.5 rounded-xl uppercase transition shadow-lg shadow-green-600/20">+ Node Onboard</button>
                
                <button onclick="toggleRequests()" class="relative p-2.5 bg-slate-100 rounded-xl hover:bg-slate-200 transition">
                    <i class="fas fa-satellite"></i>
                    <span id="notif-count" class="absolute -top-1 -right-1 bg-red-600 text-white text-[9px] font-black w-5 h-5 rounded-full flex items-center justify-center hidden border-2 border-white">0</span>
                </button>

                <div class="h-8 w-[1px] bg-slate-200 mx-2"></div>
                
                <button onclick="auth.signOut().then(()=>location.reload())" class="text-slate-400 hover:text-red-600 transition text-xs font-black uppercase">
                    <i class="fas fa-power-off"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-[1600px] mx-auto p-4 md:p-8">
        
        <div id="login-ui" class="max-w-md mx-auto bg-white rounded-[3rem] shadow-2xl overflow-hidden mt-12 border border-slate-100">
            <div class="gradient-dark p-12 text-white text-center hero-pattern">
                <div class="inline-flex h-20 w-20 items-center justify-center bg-white/10 rounded-full mb-6 backdrop-blur-md">
                    <i class="fas fa-fingerprint text-4xl text-green-400"></i>
                </div>
                <h2 class="text-2xl font-black uppercase tracking-widest">Master Access</h2>
                <p class="text-[10px] text-green-300 uppercase mt-2 tracking-widest opacity-70">Secured Strategic Infrastructure</p>
            </div>
            <form id="login-form" class="p-10 space-y-4">
                <div class="relative">
                    <i class="fas fa-envelope absolute left-5 top-5 text-slate-300"></i>
                    <input type="email" id="admin-email" placeholder="Registry Email" class="w-full pl-12 pr-6 py-4 rounded-2xl border bg-slate-50 outline-none font-bold text-sm focus:ring-2 focus:ring-green-500 transition" required>
                </div>
                <div class="relative">
                    <i class="fas fa-shield-alt absolute left-5 top-5 text-slate-300"></i>
                    <input type="password" id="admin-password" placeholder="Secure PIN" class="w-full pl-12 pr-6 py-4 rounded-2xl border bg-slate-50 outline-none font-bold text-sm focus:ring-2 focus:ring-green-500 transition" required>
                </div>
                <button type="submit" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl shadow-xl hover:bg-green-700 transition uppercase text-xs tracking-widest">Establish Connection</button>
            </form>
        </div>

        <div id="dashboard-ui" class="hidden space-y-8 animate-in fade-in duration-700">
            
            <div class="grid grid-cols-2 lg:grid-cols-4 gap-4">
                <div class="glass-panel p-6 rounded-[2rem] border shadow-sm group">
                    <p class="text-[10px] font-black text-slate-400 uppercase tracking-widest group-hover:text-green-600 transition">Global Nodes</p>
                    <h3 id="stat-members" class="text-4xl font-black mt-1">0</h3>
                </div>
                <div class="glass-panel p-6 rounded-[2rem] border shadow-sm">
                    <p class="text-[10px] font-black text-blue-500 uppercase tracking-widest">MSA Aggregate</p>
                    <h3 id="stat-total-msa" class="text-2xl font-black mt-1 text-blue-600">KSh 0</h3>
                </div>
                <div class="glass-panel p-6 rounded-[2rem] border shadow-sm">
                    <p class="text-[10px] font-black text-indigo-500 uppercase tracking-widest">PSA Aggregate</p>
                    <h3 id="stat-total-psa" class="text-2xl font-black mt-1 text-indigo-600">KSh 0</h3>
                </div>
                <div class="gradient-dark p-6 rounded-[2rem] text-white shadow-2xl shadow-green-900/20">
                    <p class="text-[10px] font-black text-white/40 uppercase tracking-widest">GCA Total Value</p>
                    <h3 id="stat-total-gca" class="text-2xl font-black mt-1 text-green-400">KSh 0</h3>
                </div>
            </div>

            <div id="request-panel" class="hidden bg-white rounded-[2.5rem] border-2 border-green-500 shadow-2xl p-6 md:p-8 mb-8 animate-bounce-short">
                <div class="flex justify-between items-center mb-6">
                    <div class="flex items-center space-x-3">
                        <span class="flex h-3 w-3 rounded-full bg-green-500 animate-ping"></span>
                        <h3 class="font-black uppercase text-xs text-green-700 tracking-[0.2em]">Pending Network Integrations</h3>
                    </div>
                    <button onclick="toggleRequests()" class="text-slate-300 hover:text-red-500 transition"><i class="fas fa-times-circle"></i></button>
                </div>
                <div id="request-list" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 max-h-[40vh] overflow-y-auto custom-scrollbar"></div>
            </div>

            <div class="grid lg:grid-cols-12 gap-8">
                
                <div class="lg:col-span-4 space-y-6">
                    <div class="bg-white p-6 rounded-[2.5rem] border border-slate-200 shadow-sm sticky top-28">
                        <div class="relative mb-6">
                            <i class="fas fa-search absolute left-5 top-4.5 text-slate-300 text-xs"></i>
                            <input type="text" id="master-search" oninput="filterHierarchy()" placeholder="Scan Node Identity / Phone..." class="w-full pl-12 pr-6 py-4 rounded-2xl border bg-slate-50 outline-none focus:ring-2 focus:ring-green-500 text-[11px] font-bold uppercase">
                        </div>
                        <div id="hierarchy-tree" class="space-y-4 max-h-[60vh] overflow-y-auto custom-scrollbar pr-2">
                            </div>
                    </div>
                </div>

                <div class="lg:col-span-8 space-y-6">
                    <div class="bg-white rounded-[3.5rem] shadow-2xl border border-slate-100 overflow-hidden min-h-[70vh] flex flex-col">
                        
                        <div id="sync-placeholder" class="flex-1 flex flex-col items-center justify-center text-center p-12">
                            <div class="h-24 w-24 bg-slate-50 rounded-full flex items-center justify-center mb-6 border border-dashed border-slate-200">
                                <i class="fas fa-shield-virus text-4xl text-slate-200"></i>
                            </div>
                            <h4 class="text-xs font-black uppercase text-slate-400 tracking-[0.4em]">Forensic Offline</h4>
                            <p class="text-[10px] text-slate-300 mt-2 max-w-xs uppercase leading-relaxed font-bold">Select a network node from the directory to initiate a secure forensic synchronization</p>
                        </div>

                        <div id="sync-interface" class="hidden flex flex-col h-full animate-in slide-in-from-bottom-4 duration-500">
                            <div class="gradient-dark p-10 md:p-14 text-white hero-pattern relative">
                                <div class="flex flex-col md:flex-row justify-between items-start md:items-end gap-6">
                                    <div>
                                        <div class="flex items-center gap-3 mb-3">
                                            <div id="lock-indicator" class="text-lg"></div>
                                            <span class="px-3 py-1 bg-green-500/20 border border-green-500/30 rounded-lg text-[8px] font-black uppercase tracking-widest text-green-400">Active Node</span>
                                        </div>
                                        <h2 id="active-name" class="text-4xl md:text-6xl font-black uppercase tracking-tighter leading-none mb-4">---</h2>
                                        <div class="flex items-center space-x-4">
                                            <p id="active-phone" class="text-[11px] font-mono text-green-400 font-bold uppercase bg-black/20 px-3 py-1 rounded-md"></p>
                                            <button onclick="viewLedger()" class="text-[9px] font-black uppercase tracking-widest hover:text-green-400 transition underline underline-offset-4">Audit History</button>
                                        </div>
                                    </div>
                                    <div class="text-right">
                                        <p class="text-[8px] font-black text-green-300 uppercase mb-3 tracking-[0.2em]">Forensic Integrity</p>
                                        <div id="scan-indicator" class="px-6 py-3 bg-white/5 backdrop-blur-md rounded-2xl text-[10px] font-black uppercase tracking-widest border border-white/10">Waiting...</div>
                                    </div>
                                </div>
                            </div>

                            <div class="p-8 md:p-14 flex-1">
                                <form id="audit-form" class="space-y-10">
                                    <div class="grid md:grid-cols-2 gap-10">
                                        <div class="space-y-4">
                                            <div class="flex items-center space-x-2 ml-2">
                                                <i class="fas fa-user-shield text-indigo-500 text-xs"></i>
                                                <h4 class="text-[10px] font-black uppercase text-indigo-500 tracking-widest">Personal Assets (PSA)</h4>
                                            </div>
                                            <div class="bg-slate-50 p-8 rounded-[2.5rem] space-y-4 border border-slate-100 shadow-inner">
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">PSA Savings</label>
                                                    <input type="number" id="inp-psa" class="w-full p-4 mt-1 rounded-xl border bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-indigo-500">
                                                </div>
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">Asset Finance (AFS)</label>
                                                    <input type="number" id="inp-afs" class="w-full p-4 mt-1 rounded-xl border bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-indigo-500">
                                                </div>
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">Farm Inputs (FIS)</label>
                                                    <input type="number" id="inp-fis" class="w-full p-4 mt-1 rounded-xl border bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-indigo-500">
                                                </div>
                                            </div>
                                        </div>

                                        <div class="space-y-4">
                                            <div class="flex items-center space-x-2 ml-2">
                                                <i class="fas fa-university text-blue-500 text-xs"></i>
                                                <h4 class="text-[10px] font-black uppercase text-blue-500 tracking-widest">Regulated Assets (MSA)</h4>
                                            </div>
                                            <div class="bg-slate-50 p-8 rounded-[2.5rem] space-y-4 border border-slate-100 shadow-inner">
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">Member Savings</label>
                                                    <input type="number" id="inp-msa" class="w-full p-4 mt-1 rounded-xl border border-blue-100 bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">Group Fines</label>
                                                    <input type="number" id="inp-gff" class="w-full p-4 mt-1 rounded-xl border bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-blue-500">
                                                </div>
                                                <div>
                                                    <label class="text-[8px] font-black uppercase text-slate-400 ml-1">Mwalimu Fund</label>
                                                    <input type="number" id="inp-gmf" class="w-full p-4 mt-1 rounded-xl border bg-white outline-none font-bold text-sm focus:ring-2 focus:ring-blue-500">
                                                </div>
                                            </div>
                                        </div>
                                    </div>

                                    <div class="pt-6">
                                        <div id="drop-zone" class="w-full bg-slate-50 p-12 rounded-[3rem] border-2 border-dashed border-slate-200 text-center relative hover:bg-slate-100 transition group cursor-pointer">
                                            <input type="file" id="audit-photo" accept="image/*" class="absolute inset-0 opacity-0 cursor-pointer">
                                            <div id="upload-content">
                                                <i class="fas fa-qrcode text-5xl text-slate-300 mb-4 group-hover:text-green-600 transition group-hover:scale-110"></i>
                                                <p id="file-label" class="text-[11px] font-black uppercase text-slate-500 tracking-widest">Verify M-PESA Packet Screenshot</p>
                                                <p class="text-[8px] text-slate-400 mt-2 font-bold uppercase tracking-tighter">Maximum Age: 60 Minutes â€¢ Software Signature Required</p>
                                            </div>
                                        </div>
                                        
                                        <div id="forensic-report" class="hidden mt-6 p-5 bg-red-50 border border-red-100 rounded-2xl flex items-center space-x-4">
                                            <div class="h-10 w-10 rounded-full bg-red-100 flex items-center justify-center text-red-600">
                                                <i class="fas fa-shield-alt"></i>
                                            </div>
                                            <p id="error-text" class="text-[10px] font-black text-red-600 uppercase tracking-widest leading-relaxed"></p>
                                        </div>

                                        <p id="lock-error" class="text-center text-[10px] font-black text-red-500 uppercase mt-6 tracking-widest hidden">Access denied: Node currently locked for verification cooling</p>
                                        
                                        <button type="submit" id="sync-btn" class="w-full mt-8 bg-slate-900 text-white font-black py-8 rounded-[2.5rem] shadow-2xl hover:bg-green-700 transition uppercase tracking-[0.3em] text-xs disabled:opacity-30 disabled:cursor-not-allowed">Execute Strategic Sync</button>
                                    </div>
                                </form>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>

    <div id="onboard-modal" class="fixed inset-0 bg-slate-900/90 backdrop-blur-md z-[500] hidden items-center justify-center p-4">
        <div class="bg-white w-full max-w-lg rounded-[3.5rem] p-10 md:p-14 shadow-2xl space-y-8 animate-in zoom-in-95 duration-300">
            <div class="text-center space-y-2">
                <h3 class="text-2xl font-black uppercase tracking-tighter">Node Onboarding</h3>
                <p class="text-[10px] font-bold text-slate-400 uppercase tracking-widest">Manual Network Integration Registry</p>
            </div>
            <form id="onboard-form" class="space-y-4">
                <input type="text" id="on-name" placeholder="Full Legal Identity" class="w-full p-5 rounded-2xl border bg-slate-50 outline-none font-bold text-sm focus:ring-2 focus:ring-green-500" required>
                <input type="text" id="on-phone" placeholder="Registry Mobile Number" class="w-full p-5 rounded-2xl border bg-slate-50 outline-none font-bold text-sm focus:ring-2 focus:ring-green-500" required>
                <div class="grid grid-cols-2 gap-4">
                    <select id="on-center" onchange="filterOnboardGroups()" class="w-full p-5 rounded-2xl border bg-slate-50 outline-none font-bold text-xs uppercase" required></select>
                    <select id="on-group" class="w-full p-5 rounded-2xl border bg-slate-50 outline-none font-bold text-xs uppercase" required></select>
                </div>
                <div class="flex gap-4 pt-6">
                    <button type="button" onclick="document.getElementById('onboard-modal').classList.add('hidden')" class="flex-1 py-5 bg-slate-100 rounded-2xl font-black uppercase text-[10px] hover:bg-slate-200 transition">Abort</button>
                    <button type="submit" class="flex-1 py-5 bg-green-900 text-white rounded-2xl font-black uppercase text-[10px] shadow-xl hover:bg-green-700 transition">Integrate Node</button>
                </div>
            </form>
        </div>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDG3C4wwetbVFHCNt3latkgM7-3ntOfFmg",
            authDomain: "help-me-up-70fcc.firebaseapp.com",
            databaseURL: "https://help-me-up-70fcc-default-rtdb.firebaseio.com",
            projectId: "help-me-up-70fcc",
            storageBucket: "help-me-up-70fcc.firebasestorage.app",
            messagingSenderId: "593893312398",
            appId: "1:593893312398:web:a982fca857289fc2f206df"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();

        let db_centers = {}, db_groups = {}, db_members = {}, db_requests = {};
        let activeMemberId = null;
        const LOCK_TIME = 5 * 60 * 60 * 1000; // 5 Hour Security Lock

        // --- Auth Guard ---
        auth.onAuthStateChanged(user => {
            const whitelist = ['iigsmartfarmersltd@gmail.com', 'delstarfordisaiah@gmail.com'];
            if (user && whitelist.includes(user.email)) {
                document.getElementById('login-ui').classList.add('hidden');
                document.getElementById('dashboard-ui').classList.remove('hidden');
                document.getElementById('auth-status').classList.remove('hidden');
                startTerminalSync();
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value).catch(err => alert("Registry Access Denied: " + err.message));
        };

        // --- Data Stream ---
        function startTerminalSync() {
            database.ref('organization/centers').on('value', s => { db_centers = s.val() || {}; renderTree(); updateOnboardDropdowns(); });
            database.ref('organization/groups').on('value', s => { db_groups = s.val() || {}; renderTree(); updateOnboardDropdowns(); });
            database.ref('records/members').on('value', s => { db_members = s.val() || {}; renderTree(); updateLockState(); });
            database.ref('requests/onboarding').on('value', s => { db_requests = s.val() || {}; renderRequests(); });
        }

        // --- Forensic Core ---
        async function validateImageIntegrity(file) {
            return new Promise((resolve, reject) => {
                const indicator = document.getElementById('scan-indicator');
                const errorLog = document.getElementById('forensic-report');
                const errorText = document.getElementById('error-text');
                const dropZone = document.getElementById('drop-zone');

                indicator.innerText = "SCANNING METADATA...";
                indicator.className = "px-6 py-3 bg-yellow-500 text-white rounded-2xl text-[10px] font-black uppercase animate-pulse";
                errorLog.classList.add('hidden');
                dropZone.classList.remove('fraud-alert');

                EXIF.getData(file, function() {
                    const metadata = EXIF.getAllTags(this);
                    const software = metadata.Software || "";
                    const creationDate = metadata.DateTimeOriginal || metadata.DateTime || "";
                    
                    // Forensic Check 1: Software Signature
                    const blacklistedApps = ["Photoshop", "Canva", "PicsArt", "Lightroom", "Snapseed", "Pixlr", "Instagram", "Editor"];
                    const isEdited = blacklistedApps.some(app => software.toLowerCase().includes(app.toLowerCase()));

                    if (isEdited) return reject(`FORENSIC ALERT: Manipulation Detected. Packet processed via ${software}`);

                    // Forensic Check 2: Temporal Validity
                    const imageTime = creationDate ? new Date(creationDate.replace(/^(\d{4}):(\d{2}):(\d{2})/, "$1/$2/$3")).getTime() : file.lastModified;
                    const ageInMinutes = (Date.now() - imageTime) / (1000 * 60);

                    if (ageInMinutes > 60) return reject(`VALIDATION FAILED: Temporal drift detected (${Math.floor(ageInMinutes)}m old). Max allowed: 60m.`);

                    indicator.innerText = "VERIFIED INTEGRITY";
                    indicator.className = "px-6 py-3 bg-green-600 text-white rounded-2xl text-[10px] font-black uppercase";
                    resolve(true);
                });
            });
        }

        document.getElementById('audit-form').onsubmit = async (e) => {
            e.preventDefault();
            const btn = document.getElementById('sync-btn');
            const photo = document.getElementById('audit-photo').files[0];
            
            if(!photo) return alert("Security Packet Required for Node Sync.");

            try {
                const isValid = await validateImageIntegrity(photo);
                if (isValid) {
                    btn.innerText = "ENCRYPTING & UPLOADING...";
                    btn.disabled = true;

                    const reader = new FileReader();
                    reader.readAsDataURL(photo);
                    reader.onload = async () => {
                        const financials = {
                            psa: parseFloat(document.getElementById('inp-psa').value || 0),
                            afs: parseFloat(document.getElementById('inp-afs').value || 0),
                            fis: parseFloat(document.getElementById('inp-fis').value || 0),
                            msa: parseFloat(document.getElementById('inp-msa').value || 0),
                            gff: parseFloat(document.getElementById('inp-gff').value || 0),
                            gmf: parseFloat(document.getElementById('inp-gmf').value || 0),
                            lastAuditTime: Date.now(),
                            securityStamp: "PASSED_V8.0"
                        };
                        
                        await database.ref(`records/members/${activeMemberId}/financials`).set(financials);
                        await database.ref('records/audits').push({
                            farmerPhone: db_members[activeMemberId].phone,
                            timestamp: Date.now(),
                            officer: auth.currentUser.email,
                            financials: financials,
                            media: reader.result
                        });
                        
                        alert("Node Synchronization Complete.");
                        location.reload();
                    };
                }
            } catch (err) {
                document.getElementById('forensic-report').classList.remove('hidden');
                document.getElementById('error-text').innerText = err;
                document.getElementById('drop-zone').classList.add('fraud-alert');
                document.getElementById('scan-indicator').innerText = "REJECTED";
                document.getElementById('scan-indicator').className = "px-6 py-3 bg-red-600 text-white rounded-2xl text-[10px] font-black uppercase";
                btn.disabled = false;
            }
        };

        // --- UI & Rendering ---
        function renderTree() {
            const tree = document.getElementById('hierarchy-tree');
            tree.innerHTML = "";
            let sums = { gca: 0, msa: 0, psa: 0, count: 0 };

            Object.entries(db_centers).sort((a,b) => a[1].name.localeCompare(b[1].name)).forEach(([cId, center]) => {
                const groups = Object.entries(db_groups).filter(([_, g]) => g.parentCenter === cId);
                let cTotal = 0;

                const groupHtml = groups.map(([gId, group]) => {
                    const members = Object.entries(db_members).filter(([_, m]) => m.groupId === gId);
                    let gTotal = 0;

                    const membersHtml = members.map(([mId, m]) => {
                        sums.count++;
                        const f = m.financials || {};
                        const mSum = (parseFloat(f.msa)||0) + (parseFloat(f.gff)||0) + (parseFloat(f.gmf)||0);
                        const pSum = (parseFloat(f.psa)||0) + (parseFloat(f.afs)||0) + (parseFloat(f.fis)||0);
                        const nodeTotal = mSum + pSum;
                        sums.msa += mSum; sums.psa += pSum; sums.gca += nodeTotal; gTotal += nodeTotal;

                        const isLocked = (Date.now() - (f.lastAuditTime || 0)) < LOCK_TIME;
                        const icon = isLocked ? 'fas fa-shield-check text-green-500' : 'far fa-circle text-slate-300';

                        return `
                            <div id="node-${mId}" onclick="selectNode('${mId}')" class="member-node p-4 border rounded-2xl flex justify-between items-center bg-white mb-2" data-search="${m.name.toLowerCase()} ${m.phone}">
                                <div class="flex items-center space-x-3">
                                    <i class="${icon} text-[10px]"></i>
                                    <div>
                                        <p class="font-black text-[10px] uppercase leading-none text-slate-700">${m.name}</p>
                                        <p class="text-[8px] font-mono text-slate-400 mt-1">${m.phone}</p>
                                    </div>
                                </div>
                                <p class="text-[10px] font-black text-green-700">KSh ${nodeTotal.toLocaleString()}</p>
                            </div>`;
                    }).join('');

                    cTotal += gTotal;
                    return `
                        <div class="group-node pl-4 mb-4">
                            <div class="flex justify-between items-center cursor-pointer mb-2" onclick="toggleVis('g-${gId}')">
                                <span class="text-[10px] font-black uppercase text-blue-600 tracking-widest">${group.name}</span>
                                <span class="text-[9px] font-bold text-slate-400 bg-slate-100 px-2 py-1 rounded-lg">KSh ${gTotal.toLocaleString()}</span>
                            </div>
                            <div id="g-${gId}" class="hidden space-y-1">${membersHtml || '<p class="text-[8px] text-center italic text-slate-300">No Nodes Registered</p>'}</div>
                        </div>`;
                }).join('');

                tree.innerHTML += `
                    <div class="center-node p-5 border bg-white mb-3 rounded-[2rem] shadow-sm">
                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleVis('c-${cId}')">
                            <h3 class="font-black text-[11px] uppercase text-slate-800 tracking-[0.1em]">${center.name} Centre</h3>
                            <p class="text-[10px] font-black text-green-700">KSh ${cTotal.toLocaleString()}</p>
                        </div>
                        <div id="c-${cId}" class="hidden mt-6">${groupHtml}</div>
                    </div>`;
            });

            document.getElementById('stat-members').innerText = sums.count;
            document.getElementById('stat-total-msa').innerText = `KSh ${sums.msa.toLocaleString()}`;
            document.getElementById('stat-total-psa').innerText = `KSh ${sums.psa.toLocaleString()}`;
            document.getElementById('stat-total-gca').innerText = `KSh ${sums.gca.toLocaleString()}`;
        }

        function selectNode(id) {
            activeMemberId = id;
            const m = db_members[id];
            document.querySelectorAll('.member-node').forEach(el => el.classList.remove('active-node'));
            document.getElementById(`node-${id}`).classList.add('active-node');
            
            document.getElementById('sync-placeholder').classList.add('hidden');
            document.getElementById('sync-interface').classList.remove('hidden');
            document.getElementById('active-name').innerText = m.name;
            document.getElementById('active-phone').innerText = `MASTER REGISTRY: ${m.phone}`;
            document.getElementById('scan-indicator').innerText = "WAITING...";
            document.getElementById('scan-indicator').className = "px-6 py-3 bg-white/5 rounded-2xl text-[10px] font-black uppercase border border-white/10";
            
            const f = m.financials || {};
            ['psa', 'afs', 'fis', 'msa', 'gff', 'gmf'].forEach(key => document.getElementById(`inp-${key}`).value = f[key] || 0);
            updateLockState();
        }

        function updateLockState() {
            if(!activeMemberId) return;
            const f = db_members[activeMemberId].financials || {};
            const remaining = LOCK_TIME - (Date.now() - (f.lastAuditTime || 0));
            const isLocked = remaining > 0;
            const btn = document.getElementById('sync-btn'), err = document.getElementById('lock-error'), indicator = document.getElementById('lock-indicator');

            if(isLocked) {
                btn.disabled = true;
                err.classList.remove('hidden');
                indicator.innerHTML = '<i class="fas fa-lock text-red-500"></i>';
                err.innerText = `SECURITY LOCK ACTIVE: ${Math.ceil(remaining/60000)} MINS REMAINING`;
            } else {
                btn.disabled = false;
                err.classList.add('hidden');
                indicator.innerHTML = '<i class="fas fa-unlock text-green-500"></i>';
            }
        }

        // --- Helpers ---
        function toggleVis(id) { document.getElementById(id).classList.toggle('hidden'); }
        function toggleRequests() { document.getElementById('request-panel').classList.toggle('hidden'); }
        function openOnboard() { document.getElementById('onboard-modal').classList.remove('hidden'); }
        
        function filterHierarchy() {
            const term = document.getElementById('master-search').value.toLowerCase();
            document.querySelectorAll('.member-node').forEach(node => {
                node.classList.toggle('hidden', !node.dataset.search.includes(term));
            });
        }

        document.getElementById('audit-photo').onchange = (e) => { 
            if(e.target.files[0]) {
                document.getElementById('file-label').innerText = "SELECTED: " + e.target.files[0].name;
                validateImageIntegrity(e.target.files[0]).catch(e => console.log("Init scan blocked"));
            }
        };

        function updateOnboardDropdowns() {
            let opts = '<option value="">Target Centre</option>';
            Object.entries(db_centers).forEach(([id, c]) => opts += `<option value="${id}">${c.name}</option>`);
            document.getElementById('on-center').innerHTML = opts;
        }

        function filterOnboardGroups() {
            const cid = document.getElementById('on-center').value;
            let opts = '<option value="">Target Group</option>';
            Object.entries(db_groups).filter(([_, g]) => g.parentCenter === cid).forEach(([id, g]) => opts += `<option value="${id}">${g.name}</option>`);
            document.getElementById('on-group').innerHTML = opts;
        }

        function renderRequests() {
            const list = document.getElementById('request-list'), badge = document.getElementById('notif-count');
            let count = 0; list.innerHTML = "";
            Object.entries(db_requests).forEach(([id, r]) => {
                if(r.status === 'pending') {
                    count++;
                    list.innerHTML += `
                        <div class="p-5 bg-slate-50 border rounded-[2rem] flex justify-between items-center group hover:bg-white hover:shadow-xl transition">
                            <div>
                                <p class="font-black text-[10px] uppercase text-slate-800">${r.name}</p>
                                <p class="text-[8px] font-bold text-slate-400 uppercase mt-1">Pending Integration</p>
                            </div>
                            <button onclick="approveRequest('${id}')" class="bg-blue-600 text-white text-[8px] font-black px-4 py-2 rounded-xl uppercase hover:bg-blue-700 transition">Integrate</button>
                        </div>`;
                }
            });
            badge.innerText = count; badge.classList.toggle('hidden', count === 0);
        }

        document.getElementById('onboard-form').onsubmit = async (e) => {
            e.preventDefault();
            const node = {
                name: document.getElementById('on-name').value,
                phone: document.getElementById('on-phone').value,
                centerId: document.getElementById('on-center').value,
                groupId: document.getElementById('on-group').value,
                status: 'active',
                financials: { lastAuditTime: 0 }
            };
            await database.ref('records/members').push(node);
            alert("New Node Successfully Integrated into Global Registry.");
            document.getElementById('onboard-modal').classList.add('hidden');
        };
    </script>
</body>
</html>