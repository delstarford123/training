<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Master Terminal | IIG SMART FARMERS</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css">
    
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@400;600;700;800&display=swap');
        body { font-family: 'Plus Jakarta Sans', sans-serif; background-color: #f1f5f9; overflow-x: hidden; }
        
        .no-scrollbar::-webkit-scrollbar { display: none; }
        .member-card { background: white; border-radius: 3.5rem; box-shadow: 0 10px 40px -10px rgba(0,0,0,0.05); position: relative; }

        /* Color-Coded Fund Identity  */
        .border-msa { border-left: 8px solid #10b981; } .text-msa { color: #10b981; }
        .border-gff { border-left: 8px solid #ef4444; } .text-gff { color: #ef4444; }
        .border-gmf { border-left: 8px solid #0ea5e9; } .text-gmf { color: #0ea5e9; }
        .border-gsf { border-left: 8px solid #3b82f6; } .text-gsf { color: #3b82f6; }
        .border-psa { border-left: 8px solid #8b5cf6; } .text-psa { color: #8b5cf6; }
        .border-fis { border-left: 8px solid #f59e0b; } .text-fis { color: #f59e0b; }
        .border-gca { border-left: 8px solid #064e3b; } .text-gca { color: #064e3b; }
        .border-afs { border-left: 8px solid #d946ef; } .text-afs { color: #d946ef; }

        /* PROFESSIONAL PRINT ENGINE */
        @media print {
            .no-print, nav, aside, button, #sidebar-overlay, .evidence-input-zone { display: none !important; }
            body, html { background: white !important; height: auto !important; overflow: visible !important; }
            #main-content { padding: 0 !important; width: 100% !important; height: auto !important; overflow: visible !important; position: static !important; }
            #member-dossier { display: block !important; height: auto !important; overflow: visible !important; }
            .member-card { border: 2px solid #f1f5f9 !important; box-shadow: none !important; margin-bottom: 2rem; break-inside: avoid; }
            .audit-entry { border: 1px solid #e2e8f0 !important; break-inside: avoid; margin-bottom: 2rem; padding: 2rem !important; }
            .print-header { display: block !important; }
            input { border: none !important; background: transparent !important; pointer-events: none !important; }
        }

        #sidebar-panel { transition: transform 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
        #sidebar-panel.hidden-mobile { transform: translateX(-100%); }
    </style>
</head>
<body class="text-slate-900 flex flex-col h-screen">

    <div class="hidden print-header w-full text-center p-10 border-b-4 border-emerald-900">
        <h1 class="text-4xl font-black text-emerald-900 uppercase">IIG SMART FARMERS LTD</h1>
        <p class="text-[10px] font-bold uppercase tracking-[0.4em] text-slate-500 mt-2">Official Financial Audit & Credit Statement</p>
    </div>

    <nav class="h-[75px] bg-white border-b flex justify-between items-center px-4 md:px-8 z-[1000] no-print sticky top-0">
        <div class="flex items-center space-x-3">
            <button onclick="toggleSidebar()" class="lg:hidden p-2 text-slate-500"><i class="fas fa-bars"></i></button>
            <div class="h-10 w-10 bg-emerald-900 rounded-xl flex items-center justify-center text-white font-black shadow-lg">IIG</div>
            <h1 class="font-extrabold text-[10px] uppercase tracking-widest text-emerald-900 hidden sm:block">Strategic Terminal</h1>
        </div>
        <div id="nav-actions" class="hidden flex items-center space-x-2">
            <button onclick="window.print()" class="p-2.5 bg-slate-50 rounded-xl border text-emerald-600"><i class="fas fa-print"></i></button>
            <button onclick="auth.signOut().then(()=>location.reload())" class="p-2.5 bg-slate-50 rounded-xl border text-red-500"><i class="fas fa-power-off"></i></button>
        </div>
    </nav>

    <div class="flex flex-1 overflow-hidden relative">
        <div id="sidebar-overlay" class="fixed inset-0 bg-slate-900/50 z-[1040] hidden lg:hidden" onclick="toggleSidebar()"></div>

        <aside id="sidebar-panel" class="absolute lg:static inset-y-0 left-0 w-[85%] lg:w-[420px] bg-white border-r z-[1050] flex flex-col no-print hidden-mobile lg:transform-none">
            <div class="p-6 border-b space-y-4">
                <div class="grid grid-cols-2 gap-3">
                    <div class="p-3 bg-slate-50 rounded-2xl border text-center">
                        <p class="text-[8px] font-black text-slate-400 uppercase">Nodes</p>
                        <h3 id="stat-members" class="text-xl font-black">0</h3>
                    </div>
                    <div class="p-3 bg-emerald-900 rounded-2xl shadow-lg text-white text-center">
                        <p class="text-[8px] font-black text-emerald-300 uppercase leading-none mb-1">Ward Sum</p>
                        <h3 id="stat-total-gca" class="text-[10px] font-black">KSh 0</h3>
                    </div>
                </div>
                <input type="text" id="master-search" oninput="filterHierarchy()" placeholder="Scan Phone ID..." class="w-full px-5 py-3.5 bg-slate-50 rounded-2xl border-none text-[10px] font-bold uppercase outline-none focus:ring-2 focus:ring-emerald-500">
            </div>
            <div id="hierarchy-tree" class="flex-1 overflow-y-auto p-4 space-y-3 no-scrollbar scroll-smooth"></div>
        </aside>

        <main id="main-content" class="flex-1 bg-[#f1f5f9] overflow-y-auto p-4 md:p-8 no-scrollbar scroll-smooth">
            
            <div id="login-ui" class="max-w-md mx-auto bg-white rounded-[3rem] shadow-2xl border p-12 text-center mt-10 no-print">
                <i class="fas fa-fingerprint text-6xl text-emerald-600 mb-8"></i>
                <h2 class="text-2xl font-black uppercase text-slate-800 tracking-tighter">Officer Access</h2>
                <form id="login-form" class="mt-8 space-y-4">
                    <input type="email" id="admin-email" placeholder="Officer ID" class="w-full p-4 rounded-xl border font-bold" required>
                    <input type="password" id="admin-password" placeholder="Terminal PIN" class="w-full p-4 rounded-xl border font-bold" required>
                    <button type="submit" class="w-full bg-slate-900 text-white font-black py-5 rounded-2xl uppercase text-[10px] tracking-widest shadow-xl">Establish Link</button>
                </form>
            </div>

            <div id="member-dossier" class="hidden max-w-5xl mx-auto space-y-6 md:space-y-10 animate-fade">
                
                <div class="member-card p-6 md:p-12 relative flex flex-col md:flex-row items-center md:items-start justify-between gap-8 overflow-hidden">
                    <div class="self-start p-2 bg-white border rounded-2xl shadow-sm no-print mb-4 md:mb-0">
                        <div id="qrcode"></div>
                    </div>
                    <div class="flex-1 md:ml-12 text-center md:text-left">
                        <p id="bio-location-path" class="text-[9px] md:text-[10px] font-black text-emerald-600 uppercase tracking-[0.4em] mb-3 leading-none">---</p>
                        <h2 id="active-name" class="text-4xl md:text-7xl font-black uppercase tracking-tighter text-slate-900 leading-[0.85] mb-8">---</h2>
                        <div class="flex flex-wrap items-center justify-center md:justify-start gap-4">
                            <button onclick="speakBalance()" class="bg-slate-900 text-white px-8 py-4 rounded-2xl text-[10px] font-black uppercase tracking-widest shadow-xl no-print active:scale-95 transition-all">Somesha Salio</button>
                            <div class="text-left border-l-2 border-slate-100 pl-4">
                                <p class="text-[8px] font-black text-slate-400 uppercase">Trust score</p>
                                <p id="trust-score" class="text-xl font-black text-emerald-600">100/100</p>
                            </div>
                        </div>
                    </div>
                    <div class="text-center md:text-right w-full md:w-auto pt-6 border-t md:border-t-0 border-slate-100">
                        <p class="text-[10px] md:text-[11px] font-black text-slate-400 uppercase mb-2">Lifetime Cumulative Savings</p>
                        <h2 id="active-grand-total" class="text-6xl md:text-8xl font-black text-emerald-600 tracking-tighter leading-none">KSh 0</h2>
                        <div class="mt-4">
                            <p class="text-[9px] font-black text-amber-600 uppercase tracking-widest mb-1 leading-none">Projected Harvest [cite: 83]</p>
                            <p id="yield-projection" class="text-sm font-black text-amber-600 leading-none tracking-widest uppercase">---</p>
                        </div>
                    </div>
                </div>

                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 md:gap-6">
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-msa">
                        <h4 class="text-[9px] font-black uppercase text-msa mb-2 leading-none">MSA [cite: 66]</h4>
                        <input type="number" id="inp-msa" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-gff">
                        <h4 class="text-[9px] font-black uppercase text-gff mb-2 leading-none">GFF [cite: 67]</h4>
                        <input type="number" id="inp-gff" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-gmf">
                        <h4 class="text-[9px] font-black uppercase text-gmf mb-2 leading-none">GMF [cite: 68]</h4>
                        <input type="number" id="inp-gmf" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-gsf">
                        <h4 class="text-[9px] font-black uppercase text-gsf mb-2 leading-none">GSF [cite: 69]</h4>
                        <input type="number" id="inp-gsf" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-psa">
                        <h4 class="text-[9px] font-black uppercase text-psa mb-2 leading-none">PSA [cite: 70]</h4>
                        <input type="number" id="inp-psa" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 md:p-8 rounded-[2.5rem] border shadow-sm border-fis">
                        <h4 class="text-[9px] font-black uppercase text-fis mb-2 leading-none">FIS [cite: 71]</h4>
                        <input type="number" id="inp-fis" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm border-gca">
                        <h4 class="text-[9px] font-black uppercase text-gca mb-2 leading-none">GCA [cite: 72]</h4>
                        <input type="number" id="inp-gca" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                    <div class="bg-white p-6 rounded-[2.5rem] border shadow-sm border-afs">
                        <h4 class="text-[9px] font-black uppercase text-afs mb-2 leading-none">AFS [cite: 73]</h4>
                        <input type="number" id="inp-afs" class="w-full text-xl md:text-3xl font-black outline-none bg-transparent" placeholder="0">
                    </div>
                </div>

                <div class="bg-white p-8 md:p-12 rounded-[4rem] border shadow-sm no-print space-y-6 evidence-input-zone">
                    <h4 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.2em] border-b pb-4">Accountability Proof Nodes</h4>
                    <div class="grid md:grid-cols-2 gap-8">
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase text-slate-400 ml-2">M-Pesa Confirmation Message</label>
                            <textarea id="evidence-msg" class="w-full p-6 rounded-3xl border bg-slate-50 font-bold text-xs leading-relaxed" rows="4" placeholder="Paste full M-Pesa SMS packet here..."></textarea>
                        </div>
                        <div class="space-y-3">
                            <label class="text-[9px] font-black uppercase text-slate-400 ml-2">M-Pesa Transaction Screenshot</label>
                            <input type="file" id="evidence-img" class="w-full p-5 rounded-3xl border bg-slate-50 font-bold text-xs" accept="image/*">
                        </div>
                    </div>
                </div>

                <div class="bg-white p-8 md:p-14 rounded-[4rem] border shadow-sm space-y-12">
                    <div class="flex flex-col md:flex-row justify-between items-center gap-6 border-b pb-10">
                        <h4 class="text-[11px] font-black uppercase text-slate-400 tracking-[0.3em]">Official Accountability node Timeline</h4>
                        <button onclick="commitSync()" id="sync-btn" class="w-full md:w-auto bg-emerald-700 text-white font-black px-12 py-6 rounded-[2rem] uppercase text-[10px] tracking-widest shadow-2xl no-print hover:bg-emerald-900 transition-all">Commit Strategic Sync Packet</button>
                    </div>
                    <div id="audit-history-timeline" class="space-y-12">
                        </div>
                </div>

                <div class="grid lg:grid-cols-2 gap-6 pb-20">
                    <div class="bg-white p-8 rounded-[3rem] border space-y-6">
                        <p class="text-[9px] font-black uppercase text-slate-300">Biometric Verification</p>
                        <img id="view-sign" src="" class="h-44 w-full object-contain bg-slate-50 rounded-3xl border grayscale p-6">
                        <div class="grid grid-cols-2 gap-4">
                            <img id="view-id-front" class="h-40 w-full object-cover rounded-2xl border">
                            <img id="view-id-back" class="h-40 w-full object-cover rounded-2xl border">
                        </div>
                    </div>
                    <div class="bg-white p-8 rounded-[3rem] border flex flex-col justify-center space-y-6">
                        <div class="space-y-4">
                            <p class="flex justify-between text-[11px] font-bold uppercase tracking-widest text-slate-400">Village Hub: <span id="p-village" class="font-black text-emerald-800 uppercase">---</span></p>
                            <p class="flex justify-between text-[11px] font-bold uppercase tracking-widest text-slate-400">Node Mobile: <span id="p-phone" class="font-black text-slate-900 font-mono">---</span></p>
                        </div>
                        <div class="pt-10 border-t text-[9px] text-slate-400 font-bold uppercase text-center leading-relaxed">
                            <p>This is an official system statement. Lifetime cumulative totals represent the sum of all historical verified audit packets stored in the IIG Master Ledger.</p>
                        </div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyDG3C4wwetbVFHCNt3latkgM7-3ntOfFmg",
            authDomain: "help-me-up-70fcc.firebaseapp.com",
            databaseURL: "https://help-me-up-70fcc-default-rtdb.firebaseio.com",
            projectId: "help-me-up-70fcc",
            storageBucket: "help-me-up-70fcc.firebasestorage.app",
            messagingSenderId: "593893312398",
            appId: "1:593893312398:web:a982fca857289fc2f206df"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth(), database = firebase.database();

        let CACHE = { centers: {}, groups: {}, members: {}, audits: {} };
        let activeMemberId = null;
        const qrcode = new QRCode(document.getElementById("qrcode"), { width: 85, height: 85 });

        auth.onAuthStateChanged(user => {
            if (user) {
                document.getElementById('login-ui').classList.add('hidden');
                document.getElementById('nav-actions').classList.remove('hidden');
                startSync();
            }
        });

        document.getElementById('login-form').onsubmit = (e) => {
            e.preventDefault();
            auth.signInWithEmailAndPassword(document.getElementById('admin-email').value, document.getElementById('admin-password').value);
        };

        function startSync() {
            database.ref('organization/centers').on('value', s => { CACHE.centers = s.val() || {}; renderTree(); });
            database.ref('organization/groups').on('value', s => { CACHE.groups = s.val() || {}; renderTree(); });
            database.ref('records/members').on('value', s => { 
                CACHE.members = s.val() || {}; 
                renderTree(); 
                if(activeMemberId) populateDossier(activeMemberId);
            });
        }

        function renderTree() {
            const tree = document.getElementById('hierarchy-tree');
            tree.innerHTML = "";
            let sums = { global: 0, count: 0 };

            Object.entries(CACHE.centers).sort((a,b) => a[1].name.localeCompare(b[1].name)).forEach(([cId, center]) => {
                let cSum = 0;
                const groups = Object.entries(CACHE.groups).filter(([_, g]) => g.parentCenter === cId);
                const groupHTML = groups.map(([gId, group]) => {
                    let gSum = 0;
                    const members = Object.entries(CACHE.members).filter(([_, m]) => m.groupId === gId);
                    const memberHTML = members.map(([mId, m]) => {
                        sums.count++;
                        const bal = calculatePacketTotal(m.financials);
                        gSum += bal;
                        return `<div onclick="selectMember('${mId}')" class="p-4 flex justify-between items-center bg-white rounded-2xl mb-1.5 border-l-4 border-transparent ${activeMemberId === mId ? 'border-emerald-500 bg-emerald-50' : ''}">
                                    <span class="text-[10px] font-black uppercase text-slate-700 truncate mr-2">${m.name}</span>
                                    <span class="text-[10px] font-black text-emerald-600">KSh ${bal.toLocaleString()}</span>
                                </div>`;
                    }).join('');
                    cSum += gSum;
                    return `<div class="mb-3 p-3 bg-slate-50/50 rounded-3xl border border-slate-100">
                                <div class="flex justify-between items-center p-2 cursor-pointer" onclick="toggleNode('g-${gId}')">
                                    <span class="text-[9px] font-black uppercase text-blue-600">${group.name}</span>
                                    <span class="text-[9px] font-bold text-slate-400">KSh ${gSum.toLocaleString()}</span>
                                </div>
                                <div id="g-${gId}" class="hidden mt-3">${memberHTML || '<p class="text-[8px] text-center italic py-2">Empty</p>'}</div>
                            </div>`;
                }).join('');

                sums.global += cSum;
                tree.innerHTML += `<div class="p-6 bg-white rounded-[2.5rem] border shadow-sm mb-4">
                                        <div class="flex justify-between items-center cursor-pointer" onclick="toggleNode('c-${cId}')">
                                            <h3 class="font-black text-[11px] uppercase text-emerald-900">${center.name} Hub</h3>
                                            <span class="text-[11px] font-black text-emerald-700">KSh ${cSum.toLocaleString()}</span>
                                        </div>
                                        <div id="c-${cId}" class="hidden mt-6">${groupHTML}</div>
                                    </div>`;
            });
            document.getElementById('stat-members').innerText = sums.count;
            document.getElementById('stat-total-gca').innerText = `KSh ${sums.global.toLocaleString()}`;
        }

        async function selectMember(mId) {
            activeMemberId = mId;
            document.getElementById('member-dossier').classList.remove('hidden');
            if(window.innerWidth < 1024) toggleSidebar();
            renderTree(); populateDossier(mId);
        }

        async function populateDossier(mId) {
            const m = CACHE.members[mId];
            if(!m) return;

            document.getElementById('active-name').innerText = m.name;
            document.getElementById('p-phone').innerText = m.phone;
            document.getElementById('p-village').innerText = m.geo?.village || "NOT RECORDED";
            document.getElementById('bio-location-path').innerText = `${CACHE.centers[m.centerId]?.name || 'HUB'} HUB > ${CACHE.groups[m.groupId]?.name || 'GROUP'} NODE`;
            
            const f = m.financials || {};
            ['msa', 'gff', 'gmf', 'gsf', 'psa', 'fis', 'gca', 'afs'].forEach(k => document.getElementById(`inp-${k}`).value = f[k] || 0);
            
            const snap = await database.ref('records/audits').orderByChild('farmerPhone').equalTo(m.phone).once('value');
            let lifetimeSum = 0;
            let audits = [];
            snap.forEach(child => {
                const a = child.val();
                lifetimeSum += calculatePacketTotal(a.financials);
                audits.push(a);
            });

            document.getElementById('active-grand-total').innerText = `KSh ${lifetimeSum.toLocaleString()}`;
            document.getElementById('yield-projection').innerText = `KSh ${(f.fis * 3.8).toLocaleString()}`;
            document.getElementById('trust-score').innerText = `${Math.min(100, audits.length * 10)}/100`;

            // FULL BREAKDOWN TIMELINE RENDERING
            let logHTML = "";
            audits.reverse().forEach(a => {
                const af = a.financials || {};
                const packetSum = calculatePacketTotal(af);
                logHTML += `
                    <div class="p-8 md:p-12 bg-slate-50 rounded-[3.5rem] border animate-fade audit-entry">
                        <div class="flex flex-col md:flex-row justify-between items-start border-b pb-6 mb-8 gap-4">
                            <div>
                                <p class="text-[11px] font-black text-slate-900 uppercase">${new Date(a.timestamp).toLocaleString()}</p>
                                <p class="text-[8px] font-bold text-slate-400 mt-1 uppercase">Officer Node: ${a.officer.split('@')[0]}</p>
                            </div>
                            <div class="text-right">
                                <p class="text-[9px] font-black text-emerald-600 mb-1 uppercase tracking-widest leading-none">Audit Node Sum</p>
                                <p class="text-4xl font-black text-slate-900 leading-none">KSh ${packetSum.toLocaleString()}</p>
                            </div>
                        </div>
                        <div class="grid grid-cols-2 md:grid-cols-4 gap-6 mb-10">
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-emerald-500 text-emerald-700 shadow-sm font-black text-[10px]">MSA: ${parseFloat(af.msa||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-red-500 text-red-700 shadow-sm font-black text-[10px]">GFF: ${parseFloat(af.gff||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-sky-500 text-sky-600 shadow-sm font-black text-[10px]">GMF: ${parseFloat(af.gmf||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-blue-500 text-blue-700 shadow-sm font-black text-[10px]">GSF: ${parseFloat(af.gsf||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-purple-500 text-purple-700 shadow-sm font-black text-[10px]">PSA: ${parseFloat(af.psa||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-amber-500 text-amber-700 shadow-sm font-black text-[10px]">FIS: ${parseFloat(af.fis||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-emerald-900 text-emerald-900 shadow-sm font-black text-[10px]">GCA: ${parseFloat(af.gca||0).toLocaleString()}</div>
                            <div class="bg-white p-4 rounded-2xl border-l-4 border-l-pink-500 text-pink-700 shadow-sm font-black text-[10px]">AFS: ${parseFloat(af.afs||0).toLocaleString()}</div>
                        </div>
                        <div class="grid md:grid-cols-2 gap-10 border-t pt-8">
                            <div class="space-y-4">
                                <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest">M-Pesa Validation Message</p>
                                <div class="bg-white p-6 rounded-3xl border text-[11px] font-bold text-slate-600 italic leading-relaxed shadow-sm">${a.mpesaMsg || "No text evidence recorded."}</div>
                            </div>
                            <div class="space-y-4">
                                <p class="text-[9px] font-black text-slate-300 uppercase tracking-widest">M-Pesa Verification Image</p>
                                ${a.mpesaImg ? `<img src="${a.mpesaImg}" class="h-64 w-full object-cover rounded-[2.5rem] border shadow-md cursor-zoom-in" onclick="window.open(this.src)">` : `<div class="h-64 w-full bg-slate-100 rounded-[2.5rem] flex flex-col items-center justify-center text-slate-400"><i class="fas fa-image text-3xl mb-3 opacity-20"></i><p class="text-[9px] font-black uppercase">No Image Proof Stored</p></div>`}
                            </div>
                        </div>
                    </div>`;
            });
            document.getElementById('audit-history-timeline').innerHTML = logHTML || '<p class="text-[10px] text-center italic py-20 opacity-30">No Node History Found.</p>';
            
            document.getElementById('view-sign').src = m.signature || "";
            document.getElementById('view-id-front').src = m.idImages?.front || "";
            document.getElementById('view-id-back').src = m.idImages?.back || "";
            qrcode.makeCode(`IIG_MASTER_AUDIT_${mId}_SUM_${lifetimeSum}`);
        }

        async function commitSync() {
            if(!activeMemberId) return;
            const btn = document.getElementById('sync-btn');
            const msgInput = document.getElementById('evidence-msg');
            const imgInput = document.getElementById('evidence-img');

            if(!msgInput.value) return alert("Accountability Error: M-Pesa Message is required.");
            
            btn.disabled = true; btn.innerText = "Transmitting Packet...";

            let b64Img = "";
            if(imgInput.files[0]) {
                const reader = new FileReader();
                b64Img = await new Promise(r => { reader.onload = () => r(reader.result); reader.readAsDataURL(imgInput.files[0]); });
            }

            const fin = {
                msa: parseFloat(document.getElementById('inp-msa').value || 0),
                gff: parseFloat(document.getElementById('inp-gff').value || 0),
                gmf: parseFloat(document.getElementById('inp-gmf').value || 0),
                gsf: parseFloat(document.getElementById('inp-gsf').value || 0),
                psa: parseFloat(document.getElementById('inp-psa').value || 0),
                fis: parseFloat(document.getElementById('inp-fis').value || 0),
                gca: parseFloat(document.getElementById('inp-gca').value || 0),
                afs: parseFloat(document.getElementById('inp-afs').value || 0),
                timestamp: Date.now()
            };
            try {
                await database.ref(`records/members/${activeMemberId}/financials`).set(fin);
                await database.ref('records/audits').push({
                    farmerPhone: CACHE.members[activeMemberId].phone,
                    officer: auth.currentUser.email,
                    timestamp: Date.now(),
                    financials: fin,
                    mpesaMsg: msgInput.value,
                    mpesaImg: b64Img
                });
                msgInput.value = ""; imgInput.value = "";
                alert("Strategic Synchronization Successful.");
            } catch (e) { alert(e.message); }
            btn.disabled = false; btn.innerText = "Commit Strategic Sync Packet";
        }

        function toggleSidebar() { 
            document.getElementById('sidebar-panel').classList.toggle('hidden-mobile'); 
            document.getElementById('sidebar-overlay')?.classList.toggle('hidden');
        }
        function toggleNode(id) { document.getElementById(id).classList.toggle('hidden'); }
        function calculatePacketTotal(f) {
            return f ? (Object.values(f).filter(v => typeof v === 'number').reduce((a, b) => a + b, 0)) : 0;
        }
        function speakBalance() {
            const m = CACHE.members[activeMemberId];
            const msg = new SpeechSynthesisUtterance(`Habari ${m.name}. Salio lako la jumla ni shilingi ya Kenya, ${document.getElementById('active-grand-total').innerText}. Asanti.`);
            msg.lang = 'sw-KE'; window.speechSynthesis.speak(msg);
        }
        function filterHierarchy() {
            const term = document.getElementById('master-search').value.toLowerCase();
            document.querySelectorAll('#hierarchy-tree .p-4').forEach(row => {
                row.style.display = row.innerText.toLowerCase().includes(term) ? 'flex' : 'none';
            });
        }
    </script>
</body>
</html>